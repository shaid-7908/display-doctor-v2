<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Invoice List - Admin Dashboard</title>

    <!-- Custom fonts for this template-->
    <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="/css/sb-admin-2.css" rel="stylesheet">



    <!-- DataTables CSS -->
    <link href="/vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="/css/issuelist.css" rel="stylesheet">

    <!-- Modal Invoice Styles -->
    <style>
        .modal-xl {
            max-width: 95%;
        }

        .invoice-modal-container {
            background: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .invoice-modal-header {
            background: #2c3e50;
            color: white;
            padding: 30px 40px;
        }

        .invoice-modal-company-name {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .invoice-modal-company-details {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .invoice-modal-body {
            padding: 30px;
        }

        .invoice-modal-details {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid #3498db;
        }

        .invoice-modal-section-title {
            color: #2c3e50;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 12px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 6px;
        }

        .invoice-modal-customer-info,
        .invoice-modal-invoice-info {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .invoice-modal-service-section {
            margin-bottom: 25px;
        }

        .invoice-modal-warranty-section {
            margin-bottom: 25px;
        }

        .invoice-modal-service-title {
            color: #2c3e50;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .invoice-modal-warranty-title {
            color: #2c3e50;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .invoice-modal-warranty-title i {
            margin-right: 8px;
            color: #3498db;
        }

        .invoice-modal-service-title i {
            margin-right: 8px;
            color: #3498db;
        }

        .invoice-modal-warranty-table {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
        }

        .invoice-modal-warranty-table thead {
            background: #34495e;
            color: white;
        }

        .invoice-modal-warranty-table thead th {
            font-weight: 500;
            padding: 10px 12px;
            border: none;
            font-size: 0.85rem;
        }

        .invoice-modal-service-table {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
        }

        .invoice-modal-service-table thead {
            background: #34495e;
            color: white;
        }

        .invoice-modal-service-table thead th {
            font-weight: 500;
            padding: 10px 12px;
            border: none;
            font-size: 0.85rem;
        }

        .invoice-modal-service-table tbody td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        .invoice-modal-amount-cell {
            font-weight: 600;
            color: #27ae60;
            font-size: 1rem;
        }

        .invoice-modal-totals-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }

        .invoice-modal-totals-table td {
            padding: 6px 12px;
            border: none;
        }

        .invoice-modal-total-amount-row {
            background: #27ae60;
            color: white;
            font-weight: 600;
        }

        .invoice-modal-total-amount-row td {
            padding: 10px 12px;
            font-size: 1rem;
        }

        .invoice-modal-footer-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #3498db;
        }

        .invoice-modal-payment-info,
        .invoice-modal-technician-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
        }

        .invoice-modal-info-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .invoice-modal-info-title i {
            margin-right: 6px;
            color: #3498db;
        }

        .invoice-modal-customer-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .invoice-modal-thank-you {
            background: #ecf0f1;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            border: 1px solid #bdc3c7;
        }
        /* Search Results Styling */
                                .search-results-container {
                                    max-height: 300px;
                                    overflow-y: auto;
                                    border: 1px solid #e3e6f0;
                                    border-radius: 0.35rem;
                                    background-color: #f8f9fc;
                                }

                                .search-result-item {
                                    padding: 0.75rem 1rem;
                                    margin-bottom: 0.5rem;
                                    background: white;
                                    border: 1px solid #e3e6f0;
                                    border-radius: 0.35rem;
                                    transition: all 0.2s ease-in-out;
                                    cursor: pointer;
                                    text-decoration: none;
                                    color: inherit;
                                    display: block;
                                }

                                .search-result-item:hover {
                                    background: #f8f9fc;
                                    border-color: #4e73df;
                                    transform: translateY(-1px);
                                    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
                                    text-decoration: none;
                                    color: inherit;
                                }

                                .search-result-title {
                                    font-weight: 600;
                                    color: #5a5c69;
                                    margin-bottom: 0.25rem;
                                }

                                .search-result-meta {
                                    font-size: 0.875rem;
                                    color: #858796;
                                    margin-bottom: 0.25rem;
                                }

                                .search-result-status {
                                    display: inline-block;
                                    padding: 0.25rem 0.5rem;
                                    font-size: 0.75rem;
                                    font-weight: 600;
                                    border-radius: 0.35rem;
                                    text-transform: uppercase;
                                }

                                .status-new {
                                    background-color: #d1ecf1;
                                    color: #0c5460;
                                }

                                .status-assigned {
                                    background-color: #fff3cd;
                                    color: #856404;
                                }

                                .status-in-progress {
                                    background-color: #cce5ff;
                                    color: #004085;
                                }

                                .status-resolved {
                                    background-color: #d4edda;
                                    color: #155724;
                                }

                                .status-cancelled {
                                    background-color: #f8d7da;
                                    color: #721c24;
                                }

                                .status-scheduled {
                                    background-color: #e2e3e5;
                                    color: #383d41;
                                }

                                .invoice-status-paid {
                                    background-color: #d4edda;
                                    color: #155724;
                                }

                                .invoice-status-pending {
                                    background-color: #fff3cd;
                                    color: #856404;
                                }

                                .invoice-status-overdue {
                                    background-color: #f8d7da;
                                    color: #721c24;
                                }

                                .search-empty-state {
                                    text-align: center;
                                    padding: 2rem 1rem;
                                    color: #858796;
                                }

                                .search-empty-state i {
                                    opacity: 0.5;
                                    margin-bottom: 0.5rem;
                                }

                                .search-loading {
                                    text-align: center;
                                    padding: 1rem;
                                    color: #858796;
                                }

                                .border-right {
                                    border-right: 1px solid #e3e6f0 !important;
                                }

                                @media (max-width: 768px) {
                                    .border-right {
                                        border-right: none !important;
                                        border-bottom: 1px solid #e3e6f0;
                                        padding-bottom: 1rem;
                                        margin-bottom: 1rem;
                                    }
                                }

                                /* Animation for showing/hiding results */
                                #results {
                                    animation: slideDown 0.3s ease-out;
                                }

                                @keyframes slideDown {
                                    from {
                                        opacity: 0;
                                        transform: translateY(-10px);
                                    }

                                    to {
                                        opacity: 1;
                                        transform: translateY(0);
                                    }
                                }
    </style>
</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <%- include('common/sidebar') %>

            <div id="content-wrapper" class="d-flex flex-column">

                <!-- Main Content -->
                <div id="content">

                    <!-- Topbar -->
                    <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                        <!-- Sidebar Toggle (Topbar) -->
                        <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                            <i class="fa fa-bars"></i>
                        </button>

                        <!-- Topbar Search -->
                        <form
                            class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
                            <div class="input-group">
                                <input type="text" id="overall-search" class="form-control bg-light border-0 small"
                                    placeholder="Search for..." aria-label="Search" aria-describedby="basic-addon2">
                                <div class="input-group-append">
                                    <button class="btn btn-primary" type="button">
                                        <i class="fas fa-search fa-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- Topbar Navbar -->
                        <%- include("common/topnavbar") %>

                    </nav>
                    <div class="container-fluid">
                        <div id="results" class="row" style="display: none;">
                            <div class="col-md-12 mb-4">
                                <div class="card border-left-primary shadow h-100 py-2">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="m-0 font-weight-bold text-primary">Search Results</h6>
                                        <button type="button" class="btn btn-sm btn-light" id="close-search-results">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="border-right pr-3">
                                                    <div class="d-flex align-items-center mb-3">
                                                        <i class="fas fa-ticket-alt text-primary mr-2"></i>
                                                        <h6 class="m-0 font-weight-bold text-dark">Issues</h6>
                                                        <span class="badge badge-primary ml-2" id="issues-count">0</span>
                                                    </div>
                                                    <div id="issues-results-from-search" class="search-results-container">
                                                        <div class="text-muted text-center py-3">
                                                            <i class="fas fa-search fa-2x mb-2"></i>
                                                            <p>No issues found</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="pl-3">
                                                    <div class="d-flex align-items-center mb-3">
                                                        <i class="fas fa-file-invoice text-success mr-2"></i>
                                                        <h6 class="m-0 font-weight-bold text-dark">Invoices</h6>
                                                        <span class="badge badge-success ml-2" id="invoices-count">0</span>
                                                    </div>
                                                    <div id="invoices-results-from-search" class="search-results-container">
                                                        <div class="text-muted text-center py-3">
                                                            <i class="fas fa-search fa-2x mb-2"></i>
                                                            <p>No invoices found</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="card shadow mb-4 col-md-12">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Issue Reports</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="invoiceListTable" width="100%"
                                            cellspacing="0">
                                            <thead>
                                                <tr>
                                                    <th>Invoice ID</th>
                                                    <th>Issue ID</th>
                                                    <th>Customer Info</th>
                                                    <th>Invoice Date</th>
                                                    <th>Invoice Amount</th>
                                                    <th>Invoice Status</th>
                                                    <th>Warranty</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="invoiceListTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal fade" id="invoiceModal" tabindex="-1" role="dialog" aria-labelledby="invoiceModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background: #2c3e50; color: white;">
                    <h5 class="modal-title" id="invoiceModalLabel">
                        <i class="fas fa-file-invoice mr-2"></i>Invoice Details
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body p-0" id="invoiceModalBody">
                    <!-- Invoice content will be loaded here -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-3">Loading invoice details...</p>
                    </div>
                </div>
                <div class="modal-footer" id="invoiceModalFooter">
                    <button type="button" class="btn btn-success" id="downloadInvoiceBtn">
                        <i class="fas fa-download mr-2"></i>Download PDF
                    </button>
                    <button type="button" class="btn btn-info" id="printInvoiceBtn">
                        <i class="fas fa-print mr-2"></i>Print
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>



    <!-- Edit Invoice Status Modal -->
    <div class="modal fade" id="editInvoiceModal" tabindex="-1" role="dialog" aria-labelledby="editInvoiceModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background: #f39c12; color: white;">
                    <h5 class="modal-title" id="editInvoiceModalLabel">
                        <i class="fas fa-edit mr-2"></i>Edit Invoice Status
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <div class="form-group">
                            <label for="invoiceId"><strong>Invoice ID:</strong></label>
                            <input type="text" class="form-control" id="editInvoiceId" readonly>
                        </div>
                        <div class="form-group">
                            <label for="currentStatus"><strong>Current Status:</strong></label>
                            <input type="text" class="form-control" id="currentStatus" readonly>
                        </div>
                        <div class="form-group">
                            <label for="newStatus"><strong>New Status:</strong></label>
                            <select class="form-control" id="newStatus" required>
                                <option value="">Select Status</option>
                                <option value="pending">Pending</option>
                                <option value="paid">Paid</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="statusNote"><strong>Note (Optional):</strong></label>
                            <textarea class="form-control" id="statusNote" rows="3"
                                placeholder="Add a note about this status change..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="saveStatusBtn">
                        <i class="fas fa-save mr-2"></i>Update Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Invoice Confirmation Modal -->
    <div class="modal fade" id="deleteInvoiceModal" tabindex="-1" role="dialog"
        aria-labelledby="deleteInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background: #e74c3c; color: white;">
                    <h5 class="modal-title" id="deleteInvoiceModalLabel">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Confirm Delete
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-warning mr-2"></i>
                        <strong>Warning!</strong> This action cannot be undone.
                    </div>
                    <p>Are you sure you want to delete this invoice?</p>
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Invoice Details:</h6>
                            <p class="card-text">
                                <strong>Invoice ID:</strong> <span id="deleteInvoiceId"></span><br>
                                <strong>Customer:</strong> <span id="deleteCustomerName"></span><br>
                                <strong>Amount:</strong> <span id="deleteInvoiceAmount"></span><br>
                                <strong>Status:</strong> <span id="deleteInvoiceStatus"></span>
                            </p>
                        </div>
                    </div>
                    <div class="form-group mt-3">
                        <label for="deleteReason"><strong>Reason for deletion:</strong></label>
                        <textarea class="form-control" id="deleteReason" rows="3"
                            placeholder="Please provide a reason for deleting this invoice..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash mr-2"></i>Delete Invoice
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!---- Scripts Section ---->
    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="/vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="/js/sb-admin-2.min.js"></script>

    <!-- DataTables JavaScript -->
    <script src="/vendor/datatables/jquery.dataTables.js"></script>
    <script src="/vendor/datatables/dataTables.bootstrap4.js"></script>
    <script>
        let table
        const userRole = "<%= default_user.role %>";
        function loadInvoiceList() {
            $.ajax({
                url: "/get-all-invoices",
                method: "GET",
                success: function (response) {
                    console.log(response.data);
                    loadInvoiceListInTable(response.data);
                },
                error: function (xhr) {
                    console.log(xhr);
                }
            })
        }

        function loadInvoiceListInTable(invoiceList) {
            table.clear();

            $.each(invoiceList, function (_, invoiceData) {
                // Get status indicator color
                let statusIndicator = "";
                if (invoiceData.invoice.status === "pending") statusIndicator = "warning";
                else if (invoiceData.invoice.status === "paid") statusIndicator = "success";
                else if (invoiceData.invoice.status === "cancelled") statusIndicator = "danger";

                // Format dates
                let invoiceDate = invoiceData.invoice.invoiceDate ? new Date(invoiceData.invoice.invoiceDate).toLocaleDateString() : "-";
                let warrantyEnd = invoiceData.invoice.warrantyEnd ? new Date(invoiceData.invoice.warrantyEnd).toLocaleDateString() : "-";

                // Format customer info
                let customerInfo = `
                    <div class='d-flex flex-column'>
                        <div><strong>Name:</strong> ${invoiceData.contact.name}</div>
                        <div><strong>Phone:</strong> ${invoiceData.contact.phone}</div>
                        <div><strong>Email:</strong> ${invoiceData.contact.email || 'N/A'}</div>
                    </div>
                `;

                // Format warranty info
                let warrantyInfo = `
                    <div class='d-flex flex-column'>
                        <div><strong>Months:</strong> ${invoiceData.invoice.warrantyMonths}</div>
                        <div><strong>Until:</strong> ${warrantyEnd}</div>
                    </div>
                `;

                // Action buttons
                let actionButtons = `
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-primary view-invoice-btn" data-invoice-id="${invoiceData.invoice.human_readable_invoice_id}" title="View Invoice">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-success download-pdf-btn" data-issue-id="${invoiceData.human_readable_id}" title="Download PDF">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-info print-invoice-btn" data-invoice-id="${invoiceData.invoice._id}" title="Print Invoice">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-sm btn-warning edit-invoice-btn" data-invoice-id="${invoiceData.invoice._id}" title="Edit Invoice">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${userRole === "admin" ? `
                            <button class="btn btn-sm btn-danger delete-invoice-btn" data-invoice-id="${invoiceData.invoice._id}" title="Delete Invoice">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ""}
                    </div>
                `;

                table.row.add([
                    invoiceData.invoice.human_readable_invoice_id || "-",
                    invoiceData.human_readable_id || "-",
                    customerInfo,
                    `<strong>${invoiceDate}</strong>`,
                    `<strong>₹${invoiceData.invoice.finalAmount.toLocaleString()}</strong>`,
                    `<div class="btn btn-${statusIndicator} btn-sm">${invoiceData.invoice.status.toUpperCase()}</div>`,
                    warrantyInfo,
                    actionButtons
                ]);
            });

            table.draw();
        }

        $(document).ready(function () {
            loadInvoiceList();
            table = $('#invoiceListTable').DataTable({
                paging: true,
                searching: true,
                ordering: true,
                lengthChange: true,
                pageLength: 10
            });

            // Event handler for view invoice button
            $(document).on('click', '.view-invoice-btn', function (e) {
                e.preventDefault();
                const invoiceId = $(this).data('invoice-id');

                // Show modal
                $('#invoiceModal').modal('show');

                // Reset modal content to loading state
                $('#invoiceModalBody').html(`
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-3">Loading invoice details...</p>
                    </div>
                `);

                // Make AJAX call to fetch invoice data (dummy for now)
                fetchInvoiceData(invoiceId);
            });

            // Event handler for download PDF button
            $(document).on('click', '.download-pdf-btn', function (e) {
                e.preventDefault();
                const issueId = $(this).data('issue-id');
                // Download invoice PDF
                window.open(`/download-invoice-pdf/${issueId}`, '_blank');
            });

            // Event handler for print invoice button
            $(document).on('click', '.print-invoice-btn', function (e) {
                e.preventDefault();
                const invoiceId = $(this).data('invoice-id');
                // Print invoice
                window.open(`/print-invoice/${invoiceId}`, '_blank');
            });

            // Event handler for edit invoice button
            $(document).on('click', '.edit-invoice-btn', function (e) {
                e.preventDefault();
                const invoiceId = $(this).data('invoice-id');

                // Find the invoice data from the table
                const currentRow = $(this).closest('tr');
                const invoiceData = table.row(currentRow).data();

                // Populate the edit modal
                $('#editInvoiceId').val(invoiceData[0]); // Invoice ID
                $('#currentStatus').val(invoiceData[5].replace(/<[^>]*>/g, '').trim()); // Remove HTML and get status
                $('#newStatus').val(''); // Reset selection
                $('#statusNote').val(''); // Reset note

                // Store invoice ID for later use
                $('#saveStatusBtn').data('invoice-id', invoiceId);

                // Show the modal
                $('#editInvoiceModal').modal('show');
            });

            // Event handler for delete invoice button (admin only)
            $(document).on('click', '.delete-invoice-btn', function (e) {
                e.preventDefault();
                const invoiceId = $(this).data('invoice-id');

                // Find the invoice data from the table
                const currentRow = $(this).closest('tr');
                const invoiceData = table.row(currentRow).data();

                // Populate the delete modal
                $('#deleteInvoiceId').text(invoiceData[0]); // Invoice ID
                $('#deleteCustomerName').text($(invoiceData[2]).find('div:first strong').next().text()); // Customer name
                $('#deleteInvoiceAmount').text(invoiceData[4]); // Invoice amount
                $('#deleteInvoiceStatus').text(invoiceData[5].replace(/<[^>]*>/g, '').trim()); // Status without HTML
                $('#deleteReason').val(''); // Reset reason

                // Store invoice ID for later use
                $('#confirmDeleteBtn').data('invoice-id', invoiceId);

                // Show the modal
                $('#deleteInvoiceModal').modal('show');
            });

            // Event handler for save status button
            $('#saveStatusBtn').on('click', function () {
                const invoiceId = $(this).data('invoice-id');
                const currentStatus = $('#currentStatus').val();
                const newStatus = $('#newStatus').val();
                const statusNote = $('#statusNote').val();

                if (!newStatus) {
                    alert('Please select a new status');
                    return;
                }

                if (newStatus === currentStatus.toLowerCase()) {
                    alert('New status cannot be the same as current status');
                    return;
                }

                // Show loading state
                $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Updating...');

                // API call for status update
                $.ajax({
                    url: `/update-invoice-status/${invoiceId}`,
                    method: 'PUT',
                    data: {
                        newStatus: newStatus,
                        note: statusNote
                    },
                    success: function (response) {
                        console.log('Invoice status updated:', response);

                        // Hide modal
                        $('#editInvoiceModal').modal('hide');

                        // Show success message
                        alert(`Invoice status updated successfully from "${currentStatus}" to "${newStatus.toUpperCase()}"`);

                        // Reset button
                        $('#saveStatusBtn').prop('disabled', false).html('<i class="fas fa-save mr-2"></i>Update Status');

                        // Reload the invoice list to show updated status
                        loadInvoiceList();
                    },
                    error: function (xhr) {
                        console.error('Error updating invoice status:', xhr);

                        // Reset button
                        $('#saveStatusBtn').prop('disabled', false).html('<i class="fas fa-save mr-2"></i>Update Status');

                        // Show error message
                        const errorMessage = xhr.responseJSON?.message || 'Failed to update invoice status';
                        alert(`Error: ${errorMessage}`);
                    }
                });
            });

            // Event handler for confirm delete button
            $('#confirmDeleteBtn').on('click', function () {
                const invoiceId = $(this).data('invoice-id');
                const deleteReason = $('#deleteReason').val().trim();

                if (!deleteReason) {
                    alert('Please provide a reason for deletion');
                    return;
                }

                if (deleteReason.length < 10) {
                    alert('Deletion reason must be at least 10 characters long');
                    return;
                }

                // Show loading state
                $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...');

                // API call for deletion
                $.ajax({
                    url: `/delete-invoice/${invoiceId}`,
                    method: 'DELETE',
                    data: {
                        reason: deleteReason
                    },
                    success: function (response) {
                        console.log('Invoice deleted:', response);

                        // Hide modal
                        $('#deleteInvoiceModal').modal('hide');

                        // Show success message
                        alert(`Invoice deleted successfully. Reason: ${deleteReason}`);

                        // Reset button
                        $('#confirmDeleteBtn').prop('disabled', false).html('<i class="fas fa-trash mr-2"></i>Delete Invoice');

                        // Reload the invoice list to remove deleted invoice
                        loadInvoiceList();
                    },
                    error: function (xhr) {
                        console.error('Error deleting invoice:', xhr);

                        // Reset button
                        $('#confirmDeleteBtn').prop('disabled', false).html('<i class="fas fa-trash mr-2"></i>Delete Invoice');

                        // Show error message
                        const errorMessage = xhr.responseJSON?.message || 'Failed to delete invoice';
                        alert(`Error: ${errorMessage}`);
                    }
                });
            });

            // Modal footer button handlers
            $('#downloadInvoiceBtn').on('click', function () {
                const issueId = $(this).data('current-invoice-id');
                if (issueId) {
                    window.open(`/download-invoice-pdf/${issueId}`, '_blank');
                }
            });

            $('#printInvoiceBtn').on('click', function () {
                // Print only the modal content
                const printContent = document.getElementById('invoiceModalBody').innerHTML;
                const originalContent = document.body.innerHTML;
                document.body.innerHTML = printContent;
                window.print();
                document.body.innerHTML = originalContent;
                location.reload(); // Reload to restore functionality
            });
        })

        // Function to fetch invoice data via AJAX
        function fetchInvoiceData(invoiceId) {
            // For now, using dummy data - replace with actual endpoint
            $.ajax({
                url: `/get-invoice-details/${invoiceId}`, // Dummy endpoint
                method: "GET",
                success: function (response) {
                    // On success, populate modal with invoice data
                    populateInvoiceModal(response.data || getDummyInvoiceData());
                },
                error: function (xhr) {
                    console.log("Error fetching invoice:", xhr);
                    // Use dummy data for now
                    const errorMessage = xhr.responseJSON.message;

                    setTimeout(() => {
                        $('#invoiceModalBody').html(`
                        <div class="text-center py-5">
                            <h2 class="mt-3 text-danger">${errorMessage}</h2>
                        </div>
                    `);
                    }, 1000); // Simulate loading delay
                }
            });
        }

        // Function to populate invoice modal with data
        function populateInvoiceModal(invoiceData) {
            // Set the issue ID for download functionality
            $('#downloadInvoiceBtn, #printInvoiceBtn').data('current-invoice-id', invoiceData.human_readable_issue_id);
            console.log(invoiceData);
            const invoiceDate = invoiceData.invoiceDate ? new Date(invoiceData.invoiceDate).toLocaleString("en-GB", {
                day: "2-digit",
                month: "short",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit",
            }) : "-";
            const modalContent = `
                <div class="invoice-modal-container">
                    <!-- Company Header -->
                    <div class="invoice-modal-header text-center">
                        <div class="invoice-modal-company-name">
                            Display Doctor
                        </div>
                        <div class="invoice-modal-company-details">
                            <div>Address: 123, Main Street, Anytown, USA</div>
                            <div>Phone: +1-800-EMERGENCY | Email: support@emergencyresponse.com</div>
                            <div>GST No: 1234567890</div>
                        </div>
                    </div>

                    <div class="invoice-modal-body">
                        <!-- Invoice Details Section -->
                        <div class="invoice-modal-details">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="invoice-modal-customer-info">
                                        <h6 class="invoice-modal-section-title">
                                            <i class="fas fa-user mr-2"></i>Bill To
                                        </h6>
                                        <div class="invoice-modal-customer-name">${invoiceData.customerName}</div>
                                        <div class="text-muted">Phone: ${invoiceData.customerPhone}</div>
                                        <div class="text-muted">${invoiceData.customerAddress}</div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="invoice-modal-invoice-info">
                                        <h6 class="invoice-modal-section-title">
                                            <i class="fas fa-file-invoice mr-2"></i>Invoice Details
                                        </h6>
                                        <div><strong>Invoice No:</strong> ${invoiceData.human_readable_invoice_id}</div>
                                        <div><strong>Issue ID:</strong> ${invoiceData.human_readable_issue_id}</div>
                                        <div><strong>Date:</strong> ${invoiceDate}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Warrenty Section -->
                        <div class="invoice-modal-warranty-section">
                            <h5 class="invoice-modal-warranty-title">
                                <i class="fas fa-shield-alt"></i>
                                Warrenty Details
                            </h5>
                            <div class="table-responsive">
                                <table class="table invoice-modal-warranty-table table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width: 30%;">Warrenty Months</th>
                                            <th style="width: 30%;">Warrenty Start</th>
                                            <th style="width: 30%;">Warrenty End</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>${invoiceData.warrantyMonths === "0" ? "N/A" : invoiceData.warrantyMonths}</td>
                                            <td>${invoiceData.warrantyMonths !== "0" ? new Date(invoiceData.warrantyStart).toLocaleDateString() : "N/A"}</td>
                                            <td>${invoiceData.warrantyMonths ? new Date(invoiceData.warrantyEnd).toLocaleDateString() : "N/A"}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Service Details -->
                        <div class="invoice-modal-service-section">
                            <h5 class="invoice-modal-service-title">
                                <i class="fas fa-cogs"></i>
                                Service Details
                            </h5>
                            <div class="table-responsive">
                                <table class="table invoice-modal-service-table table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width: 30%;">Description</th>
                                            <th style="width: 25%;">Device Info</th>
                                            <th style="width: 25%;">Parts Used</th>
                                            <th style="width: 25%;">Service Charge</th>
                                            <th style="width: 25%;">Parts Cost</th>
                                            <th style="width: 25%;">Discount</th>
                                            <th style="width: 25%;">Visit Charge</th>
                                            <th style="width: 20%;" class="text-right">Subtotal Amount (₹)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>${invoiceData.serviceDescription}</td>
                                            <td>${invoiceData.deviceInfo}</td>
                                            <td>${invoiceData.partsUsed}</td>
                                            <td class="text-right invoice-modal-amount-cell">
                                                ₹${invoiceData.labourCharge}
                                            </td>
                                            <td class="text-right invoice-modal-amount-cell">
                                                ₹${invoiceData.partsCost}
                                            </td>
                                            <td class="text-right invoice-modal-amount-cell">
                                                ₹${invoiceData.discount}
                                            </td>
                                            <td class="text-right invoice-modal-amount-cell">
                                                ₹${invoiceData.visitCharge}
                                            </td>
                                            <td class="text-right invoice-modal-amount-cell">
                                                ₹${invoiceData.labourCharge + invoiceData.partsCost}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Totals Section -->
                        <div class="row justify-content-end">
                            <div class="col-md-5">
                                <div class="invoice-modal-totals-section">
                                    <table class="table mb-0 invoice-modal-totals-table">
                                        <tr>
                                            <td><strong>Subtotal:</strong></td>
                                            <td class="text-right">
                                                <strong>₹${invoiceData.labourCharge + invoiceData.partsCost}</strong>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Visit Charge:</strong></td>
                                            <td class="text-right">
                                                <strong>₹${invoiceData.visitCharge}</strong>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Discount:</strong></td>
                                            <td class="text-right">
                                                <strong>- ₹${invoiceData.discount}</strong>
                                            </td>
                                        </tr>

                                        <tr>
                                            <td><strong>GST (18%):</strong></td>
                                            <td class="text-right">
                                                <strong>₹${(invoiceData.labourCharge + invoiceData.partsCost) * 0.18}</strong>
                                            </td>
                                        </tr>
                                        <tr class="invoice-modal-total-amount-row">
                                            <td><strong>Total Amount:</strong></td>
                                            <td class="text-right">
                                                <strong>₹${invoiceData.finalAmount}</strong>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Footer Section -->
                        <div class="invoice-modal-footer-section">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="invoice-modal-payment-info">
                                        <h6 class="invoice-modal-info-title">
                                            <i class="fas fa-university"></i>
                                            Payment Information
                                        </h6>
                                        <div><strong>Account:</strong> ${invoiceData.companyName || "N/A"}</div>
                                        <div><strong>Bank:</strong> ${invoiceData.bankName || "N/A"}</div>
                                        <div><strong>Account No:</strong> ${invoiceData.accountNo || "N/A"}</div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="invoice-modal-technician-info">
                                        <h6 class="invoice-modal-info-title">
                                            <i class="fas fa-user-cog"></i>
                                            Technician
                                        </h6>
                                        <div class="invoice-modal-customer-name">${invoiceData.technician.firstName + " " + invoiceData.technician.lastName || "N/A"}</div>
                                        <div class="text-muted">${invoiceData.technician.phone + " (" + invoiceData.technician.email + ")" || "N/A"}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Thank You Section -->
                        <div class="invoice-modal-thank-you">
                            <strong class="text-primary">Thank you for choosing Display Doctor!</strong>
                            <div class="text-muted mt-1">
                                For any queries, contact us at info@displaydoctor.com
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('#invoiceModalBody').html(modalContent);
        }

        // Dummy invoice data for testing
        function getDummyInvoiceData() {
            return {
                invoiceId: "INV-001",
                companyName: "TechFix Solutions",
                companyAddress: "123 Tech Street, Digital City, TC 12345",
                companyPhone: "+91 98765 43210",
                companyEmail: "info@techfixsolutions.com",
                companyGST: "22AAAAA0000A1Z5",
                customerName: "John Doe",
                customerPhone: "+91 87654 32109",
                customerAddress: "456 Customer Lane, User City, UC 54321",
                invoiceNo: "INV-2024-001",
                issueId: "ISS-2024-001",
                date: new Date().toLocaleDateString('en-IN'),
                dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString('en-IN'),
                serviceDescription: "Laptop Screen Replacement and System Optimization",
                deviceInfo: "HP Pavilion 15-inch, Model XYZ123",
                partsUsed: "15.6\" LCD Screen, Thermal Paste, Cleaning Kit",
                serviceAmount: 8500,
                subtotal: 8500,
                gst: 1530,
                total: 10030,
                bankName: "State Bank of India",
                accountNo: "1234567890",
                technicianName: "Mike Johnson",
                technicianTitle: "Senior Hardware Technician"
            };
        }
    </script>
    <script>
        let typingTimer;
        let debounceTime = 500;
        $(document).ready(function () {

            $('#overall-search').on('input', function () {
                clearTimeout(typingTimer); // reset timer
                let query = $(this).val().trim();

                typingTimer = setTimeout(function () {
                    if (query.length > 0) {
                        // Show loading state
                        showLoadingState();
                        $('#results').show();

                        // Make AJAX request
                        $.ajax({
                            url: '/search', // your backend route
                            method: 'GET',
                            data: { q: query },
                            success: function (response) {
                                const data = response.data;
                                renderSearchResults(data);
                            },
                            error: function (xhr, status, error) {
                                console.error('Search error:', error);
                                showErrorState();
                            }
                        });
                    } else {
                        $('#results').hide();
                        clearSearchResults();
                    }
                }, debounceTime);
            })

            // Close search results
            $(document).on('click', '#close-search-results', function () {
                $('#results').hide();
                $('#overall-search').val('');
                clearSearchResults();
            });

            function showLoadingState() {
                $('#issues-results-from-search').html(`
                        <div class="search-loading">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>Searching...</p>
                        </div>
                    `);
                $('#invoices-results-from-search').html(`
                        <div class="search-loading">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>Searching...</p>
                        </div>
                    `);
                $('#issues-count').text('...');
                $('#invoices-count').text('...');
            }

            function showErrorState() {
                $('#issues-results-from-search').html(`
                        <div class="search-empty-state">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2 text-warning"></i>
                            <p>Error occurred while searching</p>
                        </div>
                    `);
                $('#invoices-results-from-search').html(`
                        <div class="search-empty-state">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2 text-warning"></i>
                            <p>Error occurred while searching</p>
                        </div>
                    `);
            }

            function clearSearchResults() {
                $('#issues-results-from-search').html(`
                        <div class="search-empty-state">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <p>No issues found</p>
                        </div>
                    `);
                $('#invoices-results-from-search').html(`
                        <div class="search-empty-state">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <p>No invoices found</p>
                        </div>
                    `);
                $('#issues-count').text('0');
                $('#invoices-count').text('0');
            }

            function renderSearchResults(data) {
                // Render Issues
                if (data?.issues?.length > 0) {
                    let issuesHtml = '';
                    data.issues.forEach(issue => {
                        const statusClass = `status-${issue.status.replace(/_/g, '-')}`;
                        const createdDate = new Date(issue.createdAt).toLocaleDateString();

                        issuesHtml += `
                                <a href="/issue/${issue.human_readable_id}" class="search-result-item">
                                    <div class="search-result-title">
                                        <i class="fas fa-ticket-alt mr-2"></i>
                                        ${issue.human_readable_id}
                                    </div>
                                    <div class="search-result-meta">
                                        <strong>Customer:</strong> ${issue.contact?.name || 'N/A'}
                                    </div>
                                    <div class="search-result-meta">
                                        <strong>Problem:</strong> ${issue.problemDescription?.substring(0, 60)}${issue.problemDescription?.length > 60 ? '...' : ''}
                                    </div>
                                    <div class="search-result-meta">
                                        <strong>Created:</strong> ${createdDate}
                                        <span class="search-result-status ${statusClass} ml-2">${issue.status}</span>
                                    </div>
                                </a>
                            `;
                    });
                    $('#issues-results-from-search').html(issuesHtml);
                    $('#issues-count').text(data.issues.length);
                } else {
                    $('#issues-results-from-search').html(`
                            <div class="search-empty-state">
                                <i class="fas fa-search fa-2x mb-2"></i>
                                <p>No issues found</p>
                            </div>
                        `);
                    $('#issues-count').text('0');
                }

                // Render Invoices
                if (data?.invoices?.length > 0) {
                    let invoicesHtml = '';
                    data.invoices.forEach(invoice => {
                        const statusClass = `invoice-status-${invoice.status}`;
                        const invoiceDate = new Date(invoice.invoiceDate).toLocaleDateString();
                        const amount = invoice.finalAmount || 0;

                        invoicesHtml += `
                                <a href="/invoice/${invoice.human_readable_invoice_id}" class="search-result-item">
                                    <div class="search-result-title">
                                        <i class="fas fa-file-invoice mr-2"></i>
                                        ${invoice.human_readable_invoice_id || invoice.human_readable_issue_id}
                                    </div>
                                    <div class="search-result-meta">
                                        <strong>Customer:</strong> ${invoice.customerName || 'N/A'}
                                    </div>
                                    <div class="search-result-meta">
                                        <strong>Amount:</strong> ₹${amount.toLocaleString()}
                                    </div>
                                    <div class="search-result-meta">
                                        <strong>Date:</strong> ${invoiceDate}
                                        <span class="search-result-status ${statusClass} ml-2">${invoice.status}</span>
                                    </div>
                                </a>
                            `;
                    });
                    $('#invoices-results-from-search').html(invoicesHtml);
                    $('#invoices-count').text(data.invoices.length);
                } else {
                    $('#invoices-results-from-search').html(`
                            <div class="search-empty-state">
                                <i class="fas fa-search fa-2x mb-2"></i>
                                <p>No invoices found</p>
                            </div>
                        `);
                    $('#invoices-count').text('0');
                }
            }


        })
    </script>
</body>

</html>