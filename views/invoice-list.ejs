<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Invoice List - Admin Dashboard</title>

    <!-- Custom fonts for this template-->
    <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="/css/sb-admin-2.css" rel="stylesheet">



    <!-- DataTables CSS -->
    <link href="/vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="/css/issuelist.css" rel="stylesheet">

    <!-- Modal Invoice Styles -->
    <style>
        .modal-xl {
            max-width: 95%;
        }

        .invoice-modal-container {
            background: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .invoice-modal-header {
            background: #2c3e50;
            color: white;
            padding: 30px 40px;
        }

        .invoice-modal-company-name {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .invoice-modal-company-details {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .invoice-modal-body {
            padding: 30px;
        }

        .invoice-modal-details {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid #3498db;
        }

        .invoice-modal-section-title {
            color: #2c3e50;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 12px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 6px;
        }

        .invoice-modal-customer-info,
        .invoice-modal-invoice-info {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .invoice-modal-service-section {
            margin-bottom: 25px;
        }

        .invoice-modal-warranty-section {
            margin-bottom: 25px;
        }

        .invoice-modal-service-title {
            color: #2c3e50;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .invoice-modal-warranty-title {
            color: #2c3e50;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .invoice-modal-warranty-title i {
            margin-right: 8px;
            color: #3498db;
        }

        .invoice-modal-service-title i {
            margin-right: 8px;
            color: #3498db;
        }

        .invoice-modal-warranty-table {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
        }

        .invoice-modal-warranty-table thead {
            background: #34495e;
            color: white;
        }

        .invoice-modal-warranty-table thead th {
            font-weight: 500;
            padding: 10px 12px;
            border: none;
            font-size: 0.85rem;
        }

        .invoice-modal-service-table {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
        }

        .invoice-modal-service-table thead {
            background: #34495e;
            color: white;
        }

        .invoice-modal-service-table thead th {
            font-weight: 500;
            padding: 10px 12px;
            border: none;
            font-size: 0.85rem;
        }

        .invoice-modal-service-table tbody td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        .invoice-modal-amount-cell {
            font-weight: 600;
            color: #27ae60;
            font-size: 1rem;
        }

        .invoice-modal-totals-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }

        .invoice-modal-totals-table td {
            padding: 6px 12px;
            border: none;
        }

        .invoice-modal-total-amount-row {
            background: #27ae60;
            color: white;
            font-weight: 600;
        }

        .invoice-modal-total-amount-row td {
            padding: 10px 12px;
            font-size: 1rem;
        }

        .invoice-modal-footer-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #3498db;
        }

        .invoice-modal-payment-info,
        .invoice-modal-technician-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
        }

        .invoice-modal-info-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .invoice-modal-info-title i {
            margin-right: 6px;
            color: #3498db;
        }

        .invoice-modal-customer-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .invoice-modal-thank-you {
            background: #ecf0f1;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            border: 1px solid #bdc3c7;
        }
    </style>
</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <%- include('common/sidebar') %>

            <div id="content-wrapper" class="d-flex flex-column">

                <!-- Main Content -->
                <div id="content">

                    <!-- Topbar -->
                    <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                        <!-- Sidebar Toggle (Topbar) -->
                        <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                            <i class="fa fa-bars"></i>
                        </button>

                        <!-- Topbar Search -->
                        <form
                            class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
                            <div class="input-group">
                                <input type="text" class="form-control bg-light border-0 small"
                                    placeholder="Search for..." aria-label="Search" aria-describedby="basic-addon2">
                                <div class="input-group-append">
                                    <button class="btn btn-primary" type="button">
                                        <i class="fas fa-search fa-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- Topbar Navbar -->
                        <%- include("common/topnavbar") %>

                    </nav>
                    <div class="container-fluid">

                        <div class="row">
                            <div class="card shadow mb-4 col-md-12">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Issue Reports</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="invoiceListTable" width="100%"
                                            cellspacing="0">
                                            <thead>
                                                <tr>
                                                    <th>Invoice ID</th>
                                                    <th>Issue ID</th>
                                                    <th>Customer Info</th>
                                                    <th>Invoice Date</th>
                                                    <th>Invoice Amount</th>
                                                    <th>Invoice Status</th>
                                                    <th>Warranty</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="invoiceListTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal fade" id="invoiceModal" tabindex="-1" role="dialog" aria-labelledby="invoiceModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background: #2c3e50; color: white;">
                    <h5 class="modal-title" id="invoiceModalLabel">
                        <i class="fas fa-file-invoice mr-2"></i>Invoice Details
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body p-0" id="invoiceModalBody">
                    <!-- Invoice content will be loaded here -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-3">Loading invoice details...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="downloadInvoiceBtn">
                        <i class="fas fa-download mr-2"></i>Download PDF
                    </button>
                    <button type="button" class="btn btn-info" id="printInvoiceBtn">
                        <i class="fas fa-print mr-2"></i>Print
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!---- Scripts Section ---->
    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="/vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="/js/sb-admin-2.min.js"></script>

    <!-- DataTables JavaScript -->
    <script src="/vendor/datatables/jquery.dataTables.js"></script>
    <script src="/vendor/datatables/dataTables.bootstrap4.js"></script>
    <script>
        let table
        function loadInvoiceList() {
            $.ajax({
                url: "/get-all-invoices",
                method: "GET",
                success: function (response) {
                    console.log(response.data);
                    loadInvoiceListInTable(response.data);
                },
                error: function (xhr) {
                    console.log(xhr);
                }
            })
        }

        function loadInvoiceListInTable(invoiceList) {
            table.clear();

            $.each(invoiceList, function (_, invoiceData) {
                // Get status indicator color
                let statusIndicator = "";
                if (invoiceData.invoice.status === "pending") statusIndicator = "warning";
                else if (invoiceData.invoice.status === "paid") statusIndicator = "success";
                else if (invoiceData.invoice.status === "cancelled") statusIndicator = "danger";

                // Format dates
                let invoiceDate = invoiceData.invoice.invoiceDate ? new Date(invoiceData.invoice.invoiceDate).toLocaleDateString() : "-";
                let warrantyEnd = invoiceData.invoice.warrantyEnd ? new Date(invoiceData.invoice.warrantyEnd).toLocaleDateString() : "-";

                // Format customer info
                let customerInfo = `
                    <div class='d-flex flex-column'>
                        <div><strong>Name:</strong> ${invoiceData.contact.name}</div>
                        <div><strong>Phone:</strong> ${invoiceData.contact.phone}</div>
                        <div><strong>Email:</strong> ${invoiceData.contact.email || 'N/A'}</div>
                    </div>
                `;

                // Format warranty info
                let warrantyInfo = `
                    <div class='d-flex flex-column'>
                        <div><strong>Months:</strong> ${invoiceData.invoice.warrantyMonths}</div>
                        <div><strong>Until:</strong> ${warrantyEnd}</div>
                    </div>
                `;

                // Action buttons
                let actionButtons = `
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-primary view-invoice-btn" data-invoice-id="${invoiceData.invoice.human_readable_invoice_id}" title="View Invoice">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-success download-pdf-btn" data-issue-id="${invoiceData.human_readable_id}" title="Download PDF">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-info print-invoice-btn" data-invoice-id="${invoiceData.invoice._id}" title="Print Invoice">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                `;

                table.row.add([
                    invoiceData.invoice.human_readable_invoice_id || "-",
                    invoiceData.human_readable_id || "-",
                    customerInfo,
                    `<strong>${invoiceDate}</strong>`,
                    `<strong>₹${invoiceData.invoice.finalAmount.toLocaleString()}</strong>`,
                    `<div class="btn btn-${statusIndicator} btn-sm">${invoiceData.invoice.status.toUpperCase()}</div>`,
                    warrantyInfo,
                    actionButtons
                ]);
            });

            table.draw();
        }

        $(document).ready(function () {
            loadInvoiceList();
            table = $('#invoiceListTable').DataTable({
                paging: true,
                searching: true,
                ordering: true,
                lengthChange: true,
                pageLength: 10
            });

            // Event handler for view invoice button
            $(document).on('click', '.view-invoice-btn', function (e) {
                e.preventDefault();
                const invoiceId = $(this).data('invoice-id');

                // Show modal
                $('#invoiceModal').modal('show');

                // Reset modal content to loading state
                $('#invoiceModalBody').html(`
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-3">Loading invoice details...</p>
                    </div>
                `);

                // Make AJAX call to fetch invoice data (dummy for now)
                fetchInvoiceData(invoiceId);
            });

            // Event handler for download PDF button
            $(document).on('click', '.download-pdf-btn', function (e) {
                e.preventDefault();
                const issueId = $(this).data('issue-id');
                // Download invoice PDF
                window.open(`/download-invoice-pdf/${issueId}`, '_blank');
            });

            // Event handler for print invoice button
            $(document).on('click', '.print-invoice-btn', function (e) {
                e.preventDefault();
                const invoiceId = $(this).data('invoice-id');
                // Print invoice
                window.open(`/print-invoice/${invoiceId}`, '_blank');
            });

            // Modal footer button handlers
            $('#downloadInvoiceBtn').on('click', function () {
                const issueId = $(this).data('current-invoice-id');
                if (issueId) {
                    window.open(`/download-invoice-pdf/${issueId}`, '_blank');
                }
            });

            $('#printInvoiceBtn').on('click', function () {
                // Print only the modal content
                const printContent = document.getElementById('invoiceModalBody').innerHTML;
                const originalContent = document.body.innerHTML;
                document.body.innerHTML = printContent;
                window.print();
                document.body.innerHTML = originalContent;
                location.reload(); // Reload to restore functionality
            });
        })

        // Function to fetch invoice data via AJAX
        function fetchInvoiceData(invoiceId) {
            // For now, using dummy data - replace with actual endpoint
            $.ajax({
                url: `/get-invoice-details/${invoiceId}`, // Dummy endpoint
                method: "GET",
                success: function (response) {
                    // On success, populate modal with invoice data
                    populateInvoiceModal(response.data || getDummyInvoiceData());
                },
                error: function (xhr) {
                    console.log("Error fetching invoice:", xhr);
                    // Use dummy data for now
                    const errorMessage = xhr.responseJSON.message;

                    setTimeout(() => {
                        $('#invoiceModalBody').html(`
                        <div class="text-center py-5">
                            <h2 class="mt-3 text-danger">${errorMessage}</h2>
                        </div>
                    `);
                    }, 1000); // Simulate loading delay
                }
            });
        }

        // Function to populate invoice modal with data
        function populateInvoiceModal(invoiceData) {
            // Set the issue ID for download functionality
            $('#downloadInvoiceBtn, #printInvoiceBtn').data('current-invoice-id', invoiceData.human_readable_issue_id);
            console.log(invoiceData);
            const invoiceDate = invoiceData.invoiceDate ? new Date(invoiceData.invoiceDate).toLocaleString("en-GB", {
                day: "2-digit",
                month: "short",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit",
            }) : "-";
            const modalContent = `
                <div class="invoice-modal-container">
                    <!-- Company Header -->
                    <div class="invoice-modal-header text-center">
                        <div class="invoice-modal-company-name">
                            Display Doctor
                        </div>
                        <div class="invoice-modal-company-details">
                            <div>Address: 123, Main Street, Anytown, USA</div>
                            <div>Phone: +1-800-EMERGENCY | Email: support@emergencyresponse.com</div>
                            <div>GST No: 1234567890</div>
                        </div>
                    </div>

                    <div class="invoice-modal-body">
                        <!-- Invoice Details Section -->
                        <div class="invoice-modal-details">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="invoice-modal-customer-info">
                                        <h6 class="invoice-modal-section-title">
                                            <i class="fas fa-user mr-2"></i>Bill To
                                        </h6>
                                        <div class="invoice-modal-customer-name">${invoiceData.customerName}</div>
                                        <div class="text-muted">Phone: ${invoiceData.customerPhone}</div>
                                        <div class="text-muted">${invoiceData.customerAddress}</div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="invoice-modal-invoice-info">
                                        <h6 class="invoice-modal-section-title">
                                            <i class="fas fa-file-invoice mr-2"></i>Invoice Details
                                        </h6>
                                        <div><strong>Invoice No:</strong> ${invoiceData.human_readable_invoice_id}</div>
                                        <div><strong>Issue ID:</strong> ${invoiceData.human_readable_issue_id}</div>
                                        <div><strong>Date:</strong> ${invoiceDate}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Warrenty Section -->
                        <div class="invoice-modal-warranty-section">
                            <h5 class="invoice-modal-warranty-title">
                                <i class="fas fa-shield-alt"></i>
                                Warrenty Details
                            </h5>
                            <div class="table-responsive">
                                <table class="table invoice-modal-warranty-table table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width: 30%;">Warrenty Months</th>
                                            <th style="width: 30%;">Warrenty Start</th>
                                            <th style="width: 30%;">Warrenty End</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>${invoiceData.warrantyMonths === "0" ? "N/A" : invoiceData.warrantyMonths}</td>
                                            <td>${invoiceData.warrantyMonths !== "0" ? new Date(invoiceData.warrantyStart).toLocaleDateString() : "N/A"}</td>
                                            <td>${invoiceData.warrantyMonths ? new Date(invoiceData.warrantyEnd).toLocaleDateString() : "N/A"}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Service Details -->
                        <div class="invoice-modal-service-section">
                            <h5 class="invoice-modal-service-title">
                                <i class="fas fa-cogs"></i>
                                Service Details
                            </h5>
                            <div class="table-responsive">
                                <table class="table invoice-modal-service-table table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width: 30%;">Description</th>
                                            <th style="width: 25%;">Device Info</th>
                                            <th style="width: 25%;">Parts Used</th>
                                            <th style="width: 25%;">Service Charge</th>
                                            <th style="width: 25%;">Parts Cost</th>
                                            <th style="width: 25%;">Discount</th>
                                            <th style="width: 25%;">Visit Charge</th>
                                            <th style="width: 20%;" class="text-right">Subtotal Amount (₹)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>${invoiceData.serviceDescription}</td>
                                            <td>${invoiceData.deviceInfo}</td>
                                            <td>${invoiceData.partsUsed}</td>
                                            <td class="text-right invoice-modal-amount-cell">
                                                ₹${invoiceData.labourCharge}
                                            </td>
                                            <td class="text-right invoice-modal-amount-cell">
                                                ₹${invoiceData.partsCost}
                                            </td>
                                            <td class="text-right invoice-modal-amount-cell">
                                                ₹${invoiceData.discount}
                                            </td>
                                            <td class="text-right invoice-modal-amount-cell">
                                                ₹${invoiceData.visitCharge}
                                            </td>
                                            <td class="text-right invoice-modal-amount-cell">
                                                ₹${invoiceData.labourCharge + invoiceData.partsCost}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Totals Section -->
                        <div class="row justify-content-end">
                            <div class="col-md-5">
                                <div class="invoice-modal-totals-section">
                                    <table class="table mb-0 invoice-modal-totals-table">
                                        <tr>
                                            <td><strong>Subtotal:</strong></td>
                                            <td class="text-right">
                                                <strong>₹${invoiceData.labourCharge + invoiceData.partsCost}</strong>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Visit Charge:</strong></td>
                                            <td class="text-right">
                                                <strong>₹${invoiceData.visitCharge}</strong>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Discount:</strong></td>
                                            <td class="text-right">
                                                <strong>- ₹${invoiceData.discount}</strong>
                                            </td>
                                        </tr>

                                        <tr>
                                            <td><strong>GST (18%):</strong></td>
                                            <td class="text-right">
                                                <strong>₹${(invoiceData.labourCharge + invoiceData.partsCost) * 0.18}</strong>
                                            </td>
                                        </tr>
                                        <tr class="invoice-modal-total-amount-row">
                                            <td><strong>Total Amount:</strong></td>
                                            <td class="text-right">
                                                <strong>₹${invoiceData.finalAmount}</strong>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Footer Section -->
                        <div class="invoice-modal-footer-section">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="invoice-modal-payment-info">
                                        <h6 class="invoice-modal-info-title">
                                            <i class="fas fa-university"></i>
                                            Payment Information
                                        </h6>
                                        <div><strong>Account:</strong> ${invoiceData.companyName || "N/A"}</div>
                                        <div><strong>Bank:</strong> ${invoiceData.bankName || "N/A"}</div>
                                        <div><strong>Account No:</strong> ${invoiceData.accountNo || "N/A"}</div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="invoice-modal-technician-info">
                                        <h6 class="invoice-modal-info-title">
                                            <i class="fas fa-user-cog"></i>
                                            Technician
                                        </h6>
                                        <div class="invoice-modal-customer-name">${invoiceData.technician.firstName + " " + invoiceData.technician.lastName || "N/A"}</div>
                                        <div class="text-muted">${invoiceData.technician.phone + " (" + invoiceData.technician.email + ")" || "N/A"}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Thank You Section -->
                        <div class="invoice-modal-thank-you">
                            <strong class="text-primary">Thank you for choosing Display Doctor!</strong>
                            <div class="text-muted mt-1">
                                For any queries, contact us at info@displaydoctor.com
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('#invoiceModalBody').html(modalContent);
        }

        // Dummy invoice data for testing
        function getDummyInvoiceData() {
            return {
                invoiceId: "INV-001",
                companyName: "TechFix Solutions",
                companyAddress: "123 Tech Street, Digital City, TC 12345",
                companyPhone: "+91 98765 43210",
                companyEmail: "info@techfixsolutions.com",
                companyGST: "22AAAAA0000A1Z5",
                customerName: "John Doe",
                customerPhone: "+91 87654 32109",
                customerAddress: "456 Customer Lane, User City, UC 54321",
                invoiceNo: "INV-2024-001",
                issueId: "ISS-2024-001",
                date: new Date().toLocaleDateString('en-IN'),
                dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString('en-IN'),
                serviceDescription: "Laptop Screen Replacement and System Optimization",
                deviceInfo: "HP Pavilion 15-inch, Model XYZ123",
                partsUsed: "15.6\" LCD Screen, Thermal Paste, Cleaning Kit",
                serviceAmount: 8500,
                subtotal: 8500,
                gst: 1530,
                total: 10030,
                bankName: "State Bank of India",
                accountNo: "1234567890",
                technicianName: "Mike Johnson",
                technicianTitle: "Senior Hardware Technician"
            };
        }
    </script>
</body>

</html>