<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Invoice List - Admin Dashboard</title>

    <!-- Custom fonts for this template-->
    <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="/css/sb-admin-2.css" rel="stylesheet">



    <!-- DataTables CSS -->
    <link href="/vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="/css/issuelist.css" rel="stylesheet">
</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <%- include('common/sidebar') %>

            <div id="content-wrapper" class="d-flex flex-column">

                <!-- Main Content -->
                <div id="content">

                    <!-- Topbar -->
                    <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                        <!-- Sidebar Toggle (Topbar) -->
                        <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                            <i class="fa fa-bars"></i>
                        </button>

                        <!-- Topbar Search -->
                        <form
                            class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
                            <div class="input-group">
                                <input type="text" class="form-control bg-light border-0 small"
                                    placeholder="Search for..." aria-label="Search" aria-describedby="basic-addon2">
                                <div class="input-group-append">
                                    <button class="btn btn-primary" type="button">
                                        <i class="fas fa-search fa-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- Topbar Navbar -->
                        <%- include("common/topnavbar") %>

                    </nav>
                    <div class="container-fluid">

                        <div class="row">
                            <div class="card shadow mb-4 col-md-12">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Issue Reports</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="invoiceListTable" width="100%"
                                            cellspacing="0">
                                            <thead>
                                                <tr>
                                                    <th>Invoice ID</th>
                                                    <th>Issue ID</th>
                                                    <th>Customer Info</th>
                                                    <th>Invoice Date</th>
                                                    <th>Invoice Amount</th>
                                                    <th>Invoice Status</th>
                                                    <th>Warranty</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="invoiceListTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
    </div>


    <!---- Scripts Section ---->
    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="/vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="/js/sb-admin-2.min.js"></script>

    <!-- DataTables JavaScript -->
    <script src="/vendor/datatables/jquery.dataTables.js"></script>
    <script src="/vendor/datatables/dataTables.bootstrap4.js"></script>
    <script>
        let table
        function loadInvoiceList() {
            $.ajax({
                url: "/get-all-invoices",
                method: "GET",
                success: function (response) {
                    console.log(response.data);
                    loadInvoiceListInTable(response.data);
                },
                error: function (xhr) {
                    console.log(xhr);
                }
            })
        }

        function loadInvoiceListInTable(invoiceList) {
            table.clear();

            $.each(invoiceList, function (_, invoiceData) {
                // Get status indicator color
                let statusIndicator = "";
                if (invoiceData.invoice.status === "pending") statusIndicator = "warning";
                else if (invoiceData.invoice.status === "paid") statusIndicator = "success";
                else if (invoiceData.invoice.status === "cancelled") statusIndicator = "danger";

                // Format dates
                let invoiceDate = invoiceData.invoice.invoiceDate ? new Date(invoiceData.invoice.invoiceDate).toLocaleDateString() : "-";
                let warrantyEnd = invoiceData.invoice.warrantyEnd ? new Date(invoiceData.invoice.warrantyEnd).toLocaleDateString() : "-";

                // Format customer info
                let customerInfo = `
                    <div class='d-flex flex-column'>
                        <div><strong>Name:</strong> ${invoiceData.contact.name}</div>
                        <div><strong>Phone:</strong> ${invoiceData.contact.phone}</div>
                        <div><strong>Email:</strong> ${invoiceData.contact.email || 'N/A'}</div>
                    </div>
                `;

                // Format warranty info
                let warrantyInfo = `
                    <div class='d-flex flex-column'>
                        <div><strong>Months:</strong> ${invoiceData.invoice.warrantyMonths}</div>
                        <div><strong>Until:</strong> ${warrantyEnd}</div>
                    </div>
                `;

                // Action buttons
                let actionButtons = `
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-primary view-invoice-btn" data-invoice-id="${invoiceData.invoice._id}" title="View Invoice">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-success download-pdf-btn" data-issue-id="${invoiceData.human_readable_id}" title="Download PDF">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-info print-invoice-btn" data-invoice-id="${invoiceData.invoice._id}" title="Print Invoice">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                `;

                table.row.add([
                    invoiceData.invoice.human_readable_invoice_id || "-",
                    invoiceData.human_readable_id || "-",
                    customerInfo,
                    `<strong>${invoiceDate}</strong>`,
                    `<strong>â‚¹${invoiceData.invoice.finalAmount.toLocaleString()}</strong>`,
                    `<div class="btn btn-${statusIndicator} btn-sm">${invoiceData.invoice.status.toUpperCase()}</div>`,
                    warrantyInfo,
                    actionButtons
                ]);
            });

            table.draw();
        }

        $(document).ready(function () {
            loadInvoiceList();
            table = $('#invoiceListTable').DataTable({
                paging: true,
                searching: true,
                ordering: true,
                lengthChange: true,
                pageLength: 10
            });

            // Event handler for view invoice button
            $(document).on('click', '.view-invoice-btn', function (e) {
                e.preventDefault();
                const invoiceId = $(this).data('invoice-id');
                // Navigate to invoice view page
                window.open(`/view-invoice/${invoiceId}`, '_blank');
            });

            // Event handler for download PDF button
            $(document).on('click', '.download-pdf-btn', function (e) {
                e.preventDefault();
                const issueId = $(this).data('issue-id');
                // Download invoice PDF
                window.open(`/download-invoice-pdf/${issueId}`, '_blank');
            });

            // Event handler for print invoice button
            $(document).on('click', '.print-invoice-btn', function (e) {
                e.preventDefault();
                const invoiceId = $(this).data('invoice-id');
                // Print invoice
                window.open(`/print-invoice/${invoiceId}`, '_blank');
            });
        })
    </script>
</body>

</html>