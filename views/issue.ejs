<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Issue Details - Admin Dashboard</title>

    <!-- Custom fonts for this template-->
    <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="/css/sb-admin-2.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <link href="/vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="/css/issuelist.css" rel="stylesheet">
    <link href="/css/search-result.css" rel="stylesheet">

    <!-- Custom styles for issue details -->
    <style>
        .issue-details-container {
            padding: 20px 0;
        }

        .issue-header {
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(78, 115, 223, 0.3);
        }

        .issue-id {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .status-badge {
            font-size: 0.9rem;
            padding: 8px 16px;
            border-radius: 20px;
            margin-right: 10px;
        }

        .status-new {
            background-color: #17a2b8;
        }

        .status-assigned {
            background-color: #ffc107;
            color: #212529;
        }

        .status-in-progress {
            background-color: #fd7e14;
        }

        .status-completed {
            background-color: #28a745;
        }

        .status-cancelled {
            background-color: #dc3545;
        }

        .priority-badge {
            font-size: 0.85rem;
            padding: 6px 12px;
            border-radius: 15px;
        }

        .priority-urgent {
            background-color: #dc3545;
        }

        .priority-high {
            background-color: #fd7e14;
        }

        .priority-normal {
            background-color: #6c757d;
        }

        .priority-low {
            background-color: #28a745;
        }

        .section-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .section-header {
            background: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
            padding: 15px 20px;
            font-weight: 600;
            color: #5a5c69;
            display: flex;
            align-items: center;
        }

        .section-header i {
            margin-right: 10px;
            color: #4e73df;
            font-size: 1.1em;
        }

        .section-content {
            padding: 20px;
        }

        .info-row {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .info-label {
            font-weight: 600;
            color: #5a5c69;
            min-width: 140px;
            margin-right: 15px;
        }

        .info-value {
            flex: 1;
            color: #2e2e2e;
        }

        .problem-types {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }

        .problem-type-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
        }

        .problem-type-tag i {
            margin-right: 6px;
        }

        .photo-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .photo-item:hover {
            transform: scale(1.05);
        }

        .photo-item img {
            width: 120px;
            height: 120px;
            object-fit: cover;
        }

        .technician-card {
            background: #f8f9fc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4e73df;
        }

        .technician-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .technician-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 3px solid #4e73df;
        }

        .technician-details h6 {
            margin: 0;
            color: #2e2e2e;
            font-weight: 600;
        }

        .technician-details span {
            color: #858796;
            font-size: 0.9rem;
        }

        .report-card {
            background: white;
            border: 1px solid #e3e6f0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .report-header {
            background: #f8f9fc;
            padding: 12px 15px;
            border-bottom: 1px solid #e3e6f0;
            font-weight: 600;
            color: #4e73df;
        }

        .report-content {
            padding: 15px;
        }

        .quotation-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .quotation-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fc;
            border-radius: 6px;
        }

        .quotation-item .label {
            font-size: 0.8rem;
            color: #858796;
            margin-bottom: 5px;
        }

        .quotation-item .value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2e2e2e;
        }

        .history-timeline {
            position: relative;
            padding-left: 30px;
        }

        .history-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e3e6f0;
        }

        .history-item {
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .history-item::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: #4e73df;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #e3e6f0;
        }

        .history-date {
            font-size: 0.85rem;
            color: #858796;
            margin-bottom: 5px;
        }

        .history-action {
            font-weight: 600;
            color: #2e2e2e;
            margin-bottom: 5px;
        }

        .history-note {
            color: #5a5c69;
            font-size: 0.9rem;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #858796;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #d1d3e2;
        }

        @media (max-width: 768px) {
            .issue-header {
                padding: 20px 15px;
            }

            .issue-id {
                font-size: 1.5rem;
            }

            .section-content {
                padding: 15px;
            }

            .info-row {
                flex-direction: column;
                margin-bottom: 20px;
            }

            .info-label {
                min-width: auto;
                margin-bottom: 5px;
            }
        }
    </style>

</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <%- include('common/sidebar') %>

            <!-- Content Wrapper -->
            <div id="content-wrapper" class="d-flex flex-column">

                <!-- Main Content -->
                <div id="content">

                    <!-- Topbar -->
                    <%- include('common/topnavbar') %>
                        <!-- End of Topbar -->

                        <!-- Begin Page Content -->
                        <div class="container-fluid issue-details-container px-3">
                            <%- include('common/search-result-section') %>

                                <!-- Issue Header -->
                                <div class="issue-header">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <div class="issue-id">Issue #<%= issue.human_readable_id %>
                                            </div>
                                            <div class="d-flex align-items-center flex-wrap">
                                                <span class="status-badge status-<%= issue.status %>">
                                                    <i class="fas fa-circle mr-1"></i>
                                                    <%= issue.status.toUpperCase() %>
                                                </span>
                                                <span class="priority-badge priority-<%= issue.priority %>">
                                                    <i class="fas fa-flag mr-1"></i>
                                                    <%= issue.priority.toUpperCase() %>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-md-right mt-3 mt-md-0">
                                            <div class="text-white-50 mb-1">Created</div>
                                            <div class="h5 mb-0">
                                                <%= new Date(issue.createdAt).toLocaleDateString('en-US', {
                                                    year: 'numeric' , month: 'short' , day: 'numeric' , hour: '2-digit'
                                                    , minute: '2-digit' }) %>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <!-- Left Column -->
                                    <div class="col-lg-8">
                                        <!-- Contact Information -->
                                        <div class="section-card">
                                            <div class="section-header">
                                                <i class="fas fa-user"></i>
                                                Contact Information
                                            </div>
                                            <div class="section-content">
                                                <div class="info-row">
                                                    <div class="info-label">Name:</div>
                                                    <div class="info-value">
                                                        <%= issue.contact.name %>
                                                    </div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Phone:</div>
                                                    <div class="info-value">
                                                        <i class="fas fa-phone text-primary mr-2"></i>
                                                        <a href="tel:<%= issue.contact.phone %>">
                                                            <%= issue.contact.phone %>
                                                        </a>
                                                    </div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Email:</div>
                                                    <div class="info-value">
                                                        <i class="fas fa-envelope text-primary mr-2"></i>
                                                        <a href="mailto:<%= issue.contact.email %>">
                                                            <%= issue.contact.email %>
                                                        </a>
                                                    </div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Address:</div>
                                                    <div class="info-value">
                                                        <i class="fas fa-map-marker-alt text-primary mr-2"></i>
                                                        <%= issue.contact.address.line1 %><br>
                                                            <%= issue.contact.address.city %>, <%=
                                                                    issue.contact.address.state %> - <%=
                                                                        issue.contact.address.pinCode %>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Device & Problem Information -->
                                        <div class="section-card">
                                            <div class="section-header">
                                                <i class="fas fa-laptop"></i>
                                                Device & Problem Details
                                            </div>
                                            <div class="section-content">
                                                <div class="info-row">
                                                    <div class="info-label">Device Type:</div>
                                                    <div class="info-value">
                                                        <span class="badge badge-primary">
                                                            <%= issue.device.type.toUpperCase() %>
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Problem Types:</div>
                                                    <div class="info-value">
                                                        <div class="problem-types">
                                                            <% issue.generic_problem_type.forEach(function(type) { %>
                                                                <span class="problem-type-tag">
                                                                    <% if (type==='display_issue' ) { %>
                                                                        <i class="fas fa-desktop"></i>
                                                                        Display Issue
                                                                        <% } else if (type==='sound_issue' ) { %>
                                                                            <i class="fas fa-volume-mute"></i>
                                                                            Sound Issue
                                                                            <% } else if (type==='power_issue' ) { %>
                                                                                <i class="fas fa-power-off"></i>
                                                                                Power Issue
                                                                                <% } else if (type==='unknown_issue' ) {
                                                                                    %>
                                                                                    <i
                                                                                        class="fas fa-question-circle"></i>
                                                                                    Unknown Issue
                                                                                    <% } %>
                                                                </span>
                                                                <% }); %>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Description:</div>
                                                    <div class="info-value">
                                                        <%= issue.problemDescription %>
                                                    </div>
                                                </div>
                                                <% if (issue.photos && issue.photos.length> 0) { %>
                                                    <div class="info-row">
                                                        <div class="info-label">Photos:</div>
                                                        <div class="info-value">
                                                            <div class="photo-gallery">
                                                                <% issue.photos.forEach(function(photo, index) { %>
                                                                    <div class="photo-item"
                                                                        onclick="openPhotoModal('<%= photo %>')">
                                                                        <img src="<%= photo %>"
                                                                            alt="Issue Photo <%= index + 1 %>"
                                                                            loading="lazy">
                                                                    </div>
                                                                    <% }); %>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% } %>
                                                        <div class="info-row">
                                                            <div class="info-label">Source:</div>
                                                            <div class="info-value">
                                                                <span class="badge badge-info">
                                                                    <i
                                                                        class="fas fa-<%= issue.source === 'call_center' ? 'phone' : 'globe' %> mr-1"></i>
                                                                    <%= issue.source.replace('_', ' ' ).toUpperCase() %>
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <% if (issue.schedule && issue.schedule.preferredDate) { %>
                                                            <div class="info-row">
                                                                <div class="info-label">Scheduled:</div>
                                                                <div class="info-value">
                                                                    <i class="fas fa-calendar text-primary mr-2"></i>
                                                                    <%= new
                                                                        Date(issue.schedule.preferredDate).toLocaleDateString('en-US',
                                                                        { year: 'numeric' , month: 'long' ,
                                                                        day: 'numeric' }) %>
                                                                </div>
                                                            </div>
                                                            <% } %>
                                            </div>
                                        </div>

                                        <!-- Issue History Timeline -->
                                        <div class="section-card">
                                            <div class="section-header">
                                                <i class="fas fa-history"></i>
                                                Issue History
                                            </div>
                                            <div class="section-content">
                                                <div class="history-timeline">
                                                    <% issue.history.forEach(function(historyItem) { %>
                                                        <div class="history-item">
                                                            <div class="history-date">
                                                                <%= new Date(historyItem.at).toLocaleDateString('en-US',
                                                                    { year: 'numeric' , month: 'short' , day: 'numeric'
                                                                    , hour: '2-digit' , minute: '2-digit' }) %>
                                                            </div>
                                                            <div class="history-action">
                                                                Issue <%= historyItem.action %> from <%=
                                                                        historyItem.from %>
                                                            </div>
                                                            <% if (historyItem.note) { %>
                                                                <div class="history-note">
                                                                    <%= historyItem.note %>
                                                                </div>
                                                                <% } %>
                                                        </div>
                                                        <% }); %>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column -->
                                    <div class="col-lg-4">
                                        <!-- Assigned Technicians -->
                                        <div class="section-card">
                                            <div class="section-header">
                                                <i class="fas fa-tools"></i>
                                                Assigned Technicians
                                            </div>
                                            <div class="section-content">
                                                <% if (issue.technician && issue.technician.length> 0) { %>
                                                    <% issue.technician.forEach(function(tech) { %>
                                                        <div class="technician-card">
                                                            <div class="technician-info">
                                                                <img src="<%= tech.profileImage %>"
                                                                    alt="<%= tech.firstName %> <%= tech.lastName %>"
                                                                    class="technician-avatar">
                                                                <div class="technician-details">
                                                                    <h6>
                                                                        <%= tech.firstName %>
                                                                            <%= tech.lastName %>
                                                                    </h6>
                                                                    <span>
                                                                        <%= tech.email %>
                                                                    </span><br>
                                                                    <span><i class="fas fa-phone mr-1"></i>
                                                                        <%= tech.phone %>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div
                                                                class="d-flex justify-content-between align-items-center">
                                                                <span
                                                                    class="badge badge-<%= tech.status === 'active' ? 'success' : 'secondary' %>">
                                                                    <%= tech.status.toUpperCase() %>
                                                                </span>
                                                                <span
                                                                    class="badge badge-<%= tech.isVerified ? 'success' : 'warning' %>">
                                                                    <i
                                                                        class="fas fa-<%= tech.isVerified ? 'check-circle' : 'clock' %> mr-1"></i>
                                                                    <%= tech.isVerified ? 'Verified' : 'Pending' %>
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <% }); %>
                                                            <% } else { %>
                                                                <div class="empty-state">
                                                                    <i class="fas fa-user-slash"></i>
                                                                    <p>No technicians assigned yet</p>
                                                                    <% if(issue.schedule && issue.schedule.preferredDate) { %>

                                                                        <div class="btn btn-primary" id="assign-technician-btn" data-issue-id="<%= issue.human_readable_id %>" data-toggle="modal" data-target="#assignTechnicianModal">Assign Technician</div>

                                                                    <% }else{ %>
                                                                        <div id="schedule-visit-btn" data-issue-id="<%= issue.human_readable_id %>" class="btn btn-warning text-white text-sm" data-toggle="modal" data-target="#scheduleModal">
                                                                            <i class="fas fa-calendar" style="font-size: 0.8em;"></i>
                                                                            <span class="text-white">Schedule Visit</span>
                                                                        </div>
                                                                    <% } %>
                                                                    
                                                                </div>
                                                                <% } %>
                                            </div>
                                        </div>

                                        <!-- Technical Reports & Quotations -->
                                        <div class="section-card">
                                            <div class="section-header">
                                                <i class="fas fa-file-alt"></i>
                                                Reports & Quotations
                                            </div>
                                            <div class="section-content">
                                                <% if (issue.reports && issue.reports.length> 0) { %>
                                                    <% issue.reports.forEach(function(report, index) { %>
                                                        <div class="report-card">
                                                            <div class="report-header">
                                                                Report #<%= index + 1 %> - <%=
                                                                        report.issue_human_redable_id %>
                                                                        <span class="float-right">
                                                                            <span
                                                                                class="badge badge-<%= report.is_approved ? 'success' : 'warning' %>">
                                                                                <%= report.is_approved ? 'Approved'
                                                                                    : 'Pending' %>
                                                                            </span>
                                                                        </span>
                                                            </div>
                                                            <div class="report-content">
                                                                <div class="info-row">
                                                                    <div class="info-label">Device:</div>
                                                                    <div class="info-value">
                                                                        <%= report.deviceName %> (<%=
                                                                                report.deviceModelNumber %>)
                                                                    </div>
                                                                </div>

                                                                <% if (report.techNote) { %>
                                                                    <div class="info-row">
                                                                        <div class="info-label">Tech Note:</div>
                                                                        <div class="info-value">
                                                                            <%= report.techNote %>
                                                                        </div>
                                                                    </div>
                                                                    <% } %>

                                                                        <% if (report.requiredParts) { %>
                                                                            <div class="info-row">
                                                                                <div class="info-label">Required Parts:
                                                                                </div>
                                                                                <div class="info-value">
                                                                                    <%= report.requiredParts %>
                                                                                </div>
                                                                            </div>
                                                                            <% } %>

                                                                                <div class="quotation-info">
                                                                                    <div class="quotation-item">
                                                                                        <div class="label">Budget
                                                                                            Estimation</div>
                                                                                        <div class="value">₹<%=
                                                                                                report.budgetEstimation
                                                                                                ?
                                                                                                report.budgetEstimation.toLocaleString()
                                                                                                : '0' %>
                                                                                        </div>
                                                                                    </div>
                                                                                    <% if (report.initialQuotation) { %>
                                                                                        <div class="quotation-item">
                                                                                            <div class="label">Initial
                                                                                                Quotation</div>
                                                                                            <div class="value">₹<%=
                                                                                                    report.initialQuotation.toLocaleString()
                                                                                                    %>
                                                                                            </div>
                                                                                        </div>
                                                                                        <% } %>
                                                                                            <% if
                                                                                                (report.finalQuotation)
                                                                                                { %>
                                                                                                <div
                                                                                                    class="quotation-item">
                                                                                                    <div class="label">
                                                                                                        Final Quotation
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="value text-success">
                                                                                                        ₹<%= report.finalQuotation.toLocaleString()
                                                                                                            %>
                                                                                                    </div>
                                                                                                </div>
                                                                                                <% } %>
                                                                                </div>

                                                                                <div class="info-row">
                                                                                    <div class="info-label">Report
                                                                                        Status:</div>
                                                                                    <div class="info-value">
                                                                                        <span
                                                                                            class="badge badge-<%= report.status === 'open' ? 'primary' : 'success' %>">
                                                                                            <%= report.status.toUpperCase()
                                                                                                %>
                                                                                        </span>
                                                                                    </div>
                                                                                </div>

                                                                                <div class="info-row">
                                                                                    <div class="info-label">Created:
                                                                                    </div>
                                                                                    <div class="info-value">
                                                                                        <%= new
                                                                                            Date(report.createdAt).toLocaleDateString('en-US',
                                                                                            { year: 'numeric' ,
                                                                                            month: 'short' ,
                                                                                            day: 'numeric' ,
                                                                                            hour: '2-digit' ,
                                                                                            minute: '2-digit' }) %>
                                                                                    </div>
                                                                                </div>
                                                            </div>
                                                        </div>
                                                        <% }); %>
                                                            <% } else { %>
                                                                <div class="empty-state">
                                                                    <i class="fas fa-file-plus"></i>
                                                                    <p>No reports generated yet</p>
                                                                </div>
                                                                <% } %>
                                            </div>
                                        </div>

                                        <!-- Payment & SLA Information -->
                                        <div class="section-card">
                                            <div class="section-header">
                                                <i class="fas fa-info-circle"></i>
                                                Additional Information
                                            </div>
                                            <div class="section-content">
                                                <div class="info-row">
                                                    <div class="info-label">Payment Status:</div>
                                                    <div class="info-value">
                                                        <span
                                                            class="badge badge-<%= issue.payment.status === 'paid' ? 'success' : 'warning' %>">
                                                            <i
                                                                class="fas fa-<%= issue.payment.status === 'paid' ? 'check' : 'clock' %> mr-1"></i>
                                                            <%= issue.payment.status.toUpperCase() %>
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">SLA Status:</div>
                                                    <div class="info-value">
                                                        <span
                                                            class="badge badge-<%= issue.sla.isBreached ? 'danger' : 'success' %>">
                                                            <i
                                                                class="fas fa-<%= issue.sla.isBreached ? 'exclamation-triangle' : 'shield-alt' %> mr-1"></i>
                                                            <%= issue.sla.isBreached ? 'Breached' : 'Within SLA' %>
                                                        </span>
                                                    </div>
                                                </div>
                                                <% if (issue.resolution && issue.resolution.discount> 0) { %>
                                                    <div class="info-row">
                                                        <div class="info-label">Discount Applied:</div>
                                                        <div class="info-value">
                                                            <span class="badge badge-info">₹<%=
                                                                    issue.resolution.discount %></span>
                                                        </div>
                                                    </div>
                                                    <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Photo Modal -->
                                <div class="modal fade" id="photoModal" tabindex="-1" role="dialog"
                                    aria-labelledby="photoModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="photoModalLabel">Issue Photo</h5>
                                                <button type="button" class="close" data-dismiss="modal"
                                                    aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body text-center">
                                                <img id="modalPhoto" src="" alt="Issue Photo" class="img-fluid">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </div>
                </div>
            </div>
    </div>
     
    <!-- Issue Schedule Modal -->
    <div class="modal fade" id="issue_schedule_modal" tabindex="-1" role="dialog"
        aria-labelledby="issue_schedule_modal_label" aria-hidden="true">
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="issue_schedule_modal_label">Issue Schedule</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="issue_schedule_modal_body">
                        <div class="section-card mb-3">
                            <div class="section-header">
                                <div class="icon">
                                    <i class="fas fa-ticket-alt"></i>
                                </div>
                                <h6>Issue Information</h6>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Issue ID:</strong>
                                    <span id="issue-schedule-modal-issue-id"></span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Priority:</strong>
                                    <span id="issue-schedule-modal-priority"></span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <strong>Problem:</strong>
                                    <span id="issue-schedule-modal-problem"></span>
                                </div>
                            </div>
                            <div class="row mt-2" id="issue-schedule-modal-schedule-information">
                                <div class="col-12">
                                    <strong>Schedule Information:</strong>
                                    <span id="issue-schedule-modal-notes"></span>
                                </div>
                            </div>
                        </div>
                    </div>
    
    
                    <form id="issue-schedule-form">
                        <input type="hidden" id="to-be-scheduled-issue-id" name="issue_id" />
                        <div class="form-group">
                            <label for="timeWindow">Preferred Time Window</label>
                            <select class="form-control" id="timeWindow-issue-schedule-select" name="schedule.window">
                                <option value="any" selected>Any Time</option>
                                <option value="morning">Morning (9 AM - 12 PM)</option>
                                <option value="afternoon">Afternoon (12 PM - 3 PM)
                                </option>
                                <option value="evening">Evening (3 PM - 6 PM)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="preferredDate">Preferred Date (Optional)</label>
                            <input type="date" class="form-control" id="preferredDate-issue-schedule-input"
                                name="schedule.preferredDate">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            Change Schedule
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
     <!-- Assign Technician Modal -->
    <div class="modal fade" id="assignTechnicianModal" tabindex="-1" role="dialog"
        aria-labelledby="assignTechnicianModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignTechnicianModalLabel">Assign Technician</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="assignTechnicianForm">
                        <input type="hidden" id="assign-issue-id" name="issueId">
    
                        <!-- Issue Information -->
                        <div class="section-card mb-3">
                            <div class="section-header">
                                <div class="icon">
                                    <i class="fas fa-ticket-alt"></i>
                                </div>
                                <h6>Issue Information</h6>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Issue ID:</strong>
                                    <span id="assign-modal-issue-id"></span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Priority:</strong>
                                    <span id="assign-modal-priority"></span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <strong>Problem:</strong>
                                    <span id="assign-modal-problem"></span>
                                </div>
                            </div>
                        </div>
    
                        <!-- Technician Selection -->
                        <div class="form-group">
                            <label for="technicianSelect"><strong>Select Technician</strong></label>
                            <select class="form-control" id="technicianSelect" name="technicianId" required>
                                <option value="">Loading technicians...</option>
                            </select>
                            <small class="form-text text-muted">Choose a qualified technician for this service
                                type.</small>
                        </div>
    
                        <!-- Assignment Notes -->
                        <div class="form-group">
                            <label for="assignmentNotes"><strong>Assignment Notes</strong></label>
                            <textarea class="form-control" id="assignmentNotes" name="notes" rows="3"
                                placeholder="Enter any specific instructions or notes for the technician..."></textarea>
                        </div>
    
                        <!-- Priority Override -->
                        <div class="form-group">
                            <label for="priorityOverride"><strong>Priority (Optional Override)</strong></label>
                            <select class="form-control" id="priorityOverride" name="priority">
                                <option value="">Keep current priority</option>
                                <option value="low">Low</option>
                                <option value="normal">Normal</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmAssignBtn">
                        <i class="fas fa-user-plus"></i> Assign Technician
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!---- Scripts Section ---->
    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="/vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="/js/sb-admin-2.min.js"></script>

    <!-- DataTables JavaScript -->
    <script src="/vendor/datatables/jquery.dataTables.js"></script>
    <script src="/vendor/datatables/dataTables.bootstrap4.js"></script>
    <script src="/js/serach-functionality.js"></script>

    <!-- Custom JavaScript for issue details -->
    <script>
        function showNotification(message, type = 'info') {
                // Create a simple notification
                const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
                const notification = $(`
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    ${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
            `);

                $('body').append(notification);

                // Auto-remove after 5 seconds
                setTimeout(function () {
                    notification.alert('close');
                }, 5000);
            }

        // Photo modal functionality
        function openPhotoModal(photoUrl) {
            document.getElementById('modalPhoto').src = photoUrl;
            $('#photoModal').modal('show');
        }

        function openIssueScheduleModal(issueData) {
                $('#issue-schedule-modal-issue-id').text(issueData.human_readable_id);
                $('#issue-schedule-modal-priority').text(issueData.priority);
                $('#issue-schedule-modal-problem').text(issueData.problemDescription);
                $('#to-be-scheduled-issue-id').val(issueData._id)
                loadIssueSchedule(issueData._id);
                $('#issue_schedule_modal').modal('show');
            }

        function loadIssueSchedule(issueID) {
                $.ajax({
                    url: `/get-current-schedule/${issueID}`,
                    method: 'GET',
                    success: function (response) {
                        console.log('Issue schedule response:', response);

                        if (response && response.data && response.data.preferredDate && response.data.window) {
                            const preferredDate = response.data.preferredDate;
                            const timeWindow = response.data.window;
                            const formattedDate = preferredDate.split('T')[0]
                            $('#preferredDate-issue-schedule-input').val(formattedDate);
                            $('#timeWindow-issue-schedule-select').val(timeWindow)

                            $('#issue-schedule-modal-schedule-information').html(`<div class="col-12">
                                <strong>Schedule Information:<span class="text-success">Scheduled (<span id="issue-schedule-modal-notes">${formattedDate} - ${timeWindow}</span>)</span></strong>
                                
                            </div>`);

                        } else {
                            $('#issue-schedule-modal-schedule-information').html(`<div class="col-12">
                                <strong>Schedule Information:<span class="text-danger text-sm"> Not Scheduled</span></strong>
                                <span id="issue-schedule-modal-notes"></span>
                            </div>`);
                        }
                    },
                    error: function (xhr) {
                        console.log('Issue schedule error:', xhr);
                    }
                });
            }

        function openAssignTechnicianModal(issueData) {
                // Populate modal with issue data
                $('#assign-issue-id').val(issueData.human_readable_id);
                $('#assign-modal-issue-id').text(issueData.human_readable_id);
                $('#assign-modal-priority').html(`<span class="badge status-badge status-${issueData.priority}">${issueData.priority}</span>`);
                $('#assign-modal-problem').text(issueData.problemDescription || 'No description available');

                // Reset form
                $('#assignTechnicianForm')[0].reset();
                $('#assign-issue-id').val(issueData.human_readable_id);
                console.log('issueData', issueData);
                // Load technicians for this service category
                loadTechniciansForIssue(issueData.serviceCategoryId);

                // Show the modal
                $('#assignTechnicianModal').modal('show');
            }

        function loadTechniciansForIssue(serviceCategoryId) {
                $('#technicianSelect').html('<option value="">Loading technicians...</option>');

                console.log('Loading technicians for service category:', serviceCategoryId._id);

                // Check if serviceCategoryId is valid
                if (!serviceCategoryId) {
                    $('#technicianSelect').html('<option value="">No service category specified</option>');
                    return;
                }

                $.ajax({
                    url: `/get-technicians-to-assign/${serviceCategoryId}`,
                    method: 'GET',
                    success: function (response) {
                        console.log('Technicians response:', response);

                        if (response.success && response.data && response.data.length > 0) {
                            let options = '<option value="">Select a technician...</option>';

                            response.data.forEach(function (item) {
                                if (item.technician) {
                                    const tech = item.technician;
                                    options += `<option value="${tech._id}">${tech.firstName} ${tech.lastName} - ${tech.phone}</option>`;
                                }
                            });

                            $('#technicianSelect').html(options);
                            console.log('Loaded', response.data.length, 'technicians');
                        } else {
                            console.log('No technicians found or invalid response');
                            $('#technicianSelect').html('<option value="">No technicians available for this service</option>');
                        }
                    },
                    error: function () {
                        $('#technicianSelect').html('<option value="">Error loading technicians</option>');
                        showNotification('Error loading technicians', 'error');
                    }
                });
            }
        
        // Initialize tooltips and other Bootstrap components
        $(document).ready(function () {
            // Initialize tooltips
            $('[data-toggle="tooltip"]').tooltip();

            // Add smooth scrolling for any anchor links
            $('a[href^="#"]').on('click', function (event) {
                var target = $(this.getAttribute('href'));
                if (target.length) {
                    event.preventDefault();
                    $('html, body').stop().animate({
                        scrollTop: target.offset().top - 100
                    }, 1000);
                }
            });
            

            $(document).on('click', '#schedule-visit-btn', function (e) {
                e.preventDefault();
                const issueData = $(this).data('issue-id');
                $.ajax({
                    url: `/get-issue-details/${issueData}`,
                    type: 'GET',
                    success: function (response) {
                        console.log('response', response);
                        openIssueScheduleModal(response.data);
                    }
                })
            });

            $(document).on('click', '#confirmAssignBtn', function () {
                const form = $('#assignTechnicianForm');
                const issueId = $('#assign-issue-id').val();
                const technicianId = $('#technicianSelect').val();
                const notes = $('#assignmentNotes').val();
                const priority = $('#priorityOverride').val();

                if (!technicianId) {
                    showNotification('Please select a technician', 'error');
                    return;
                }

                // Disable button and show loading
                $('#confirmAssignBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Assigning...');

                $.ajax({
                    url: `/assign-issue-to-technician/${issueId}`,
                    method: 'POST',
                    data: {
                        technicianId: technicianId,
                        notes: notes,
                        priority: priority || undefined
                    },
                    success: function (response) {
                        if (response.success) {
                            showNotification('Technician assigned successfully!', 'success');
                            $('#assignTechnicianModal').modal('hide');

                            // Update the UI to show assignment

                            // Optionally reload the page to reflect changes
                            setTimeout(function () {
                                location.reload();
                            }, 1500);
                        } else {
                            showNotification(response.message || 'Assignment failed', 'error');
                        }
                    },
                    error: function (xhr) {
                        const response = xhr.responseJSON;
                        showNotification(response?.message || 'Assignment failed', 'error');
                        $('#assignTechnicianModal').modal('hide');
                    },
                    complete: function () {
                        $('#confirmAssignBtn').prop('disabled', false).html('<i class="fas fa-user-plus"></i> Assign Technician');
                    }
                });
            });

            $(document).on('click', '#assign-technician-btn', function (e) {
                    e.preventDefault();
                    const issueData = $(this).data('issue-id');
                    $.ajax({
                        url: `/get-issue-details/${issueData}`,
                        type: 'GET',
                        success: function (response) {
                            console.log('response', response);
                            openAssignTechnicianModal(response.data);
                        }
                    })
            })

            $('#issue-schedule-form').on('submit', function (e) {
                e.preventDefault()
                $.ajax({
                    url: '/change-schedule',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function (response) {
                        if (response.success) {
                            showNotification('Issue scheduled successfully','success')
                            $('#issue_schedule_modal').modal('hide')
                            setTimeout(function () {
                                location.reload();
                            }, 1500);
                        }
                    },
                    error: function (xhr, status, err) {
                        const response = xhr.responseJSON;
                        showNotification(response?.message || 'Schedule failed', 'error');
                    }
                })
            })
            // Handle assignment confirmation
            // Auto-refresh functionality (optional)
            // Uncomment if you want auto-refresh every 30 seconds
            // setInterval(function() {
            //     location.reload();
            // }, 30000);
        });

        // Print functionality
        function printIssueDetails() {
            window.print();
        }

        // Copy issue ID to clipboard
        function copyIssueId() {
            const issueId = '<%= issue.human_readable_id %>';
            navigator.clipboard.writeText(issueId).then(function () {
                alert('Issue ID copied to clipboard: ' + issueId);
            }).catch(function (err) {
                console.error('Could not copy text: ', err);
            });
        }
    </script>

</body>

</html>