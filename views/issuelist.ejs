<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Issue List - Admin Dashboard</title>

    <!-- Custom fonts for this template-->
    <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="/css/sb-admin-2.css" rel="stylesheet">



    <!-- DataTables CSS -->
    <link href="/vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="/css/issuelist.css" rel="stylesheet">
    <link href="/css/search-result.css" rel="stylesheet">
</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <%- include('common/sidebar') %>

            <!-- Content Wrapper -->
            <div id="content-wrapper" class="d-flex flex-column">

                <!-- Main Content -->
                <div id="content">

                    <!-- Topbar -->
                    <%- include("common/topnavbar") %>
                    <!-- End of Topbar -->

                    <!-- Begin Page Content -->
                    <div class="container-fluid">
                        <%- include("common/search-result-section") %>
                        <!-- Page Heading -->
                        <div class="d-sm-flex align-items-center justify-content-between mb-4">
                            <h1 class="h3 mb-0 text-gray-800">Issue Management</h1>
                            <a href="/create-issue" class="d-none d-sm-inline-block btn btn-primary shadow-sm">
                                <i class="fas fa-plus fa-sm text-white-50 mr-2"></i>Create New Issue
                            </a>
                        </div>

                        <!-- Flash Message -->
                        <%- include('common/flash-message') %>

                            <!-- Statistics Cards -->
                            <div class="row mb-4">
                                <div class="col-xl-3 col-md-6 mb-4">
                                    <div class="card border-left-primary shadow h-100 py-2">
                                        <div class="card-body">
                                            <div class="row no-gutters align-items-center">
                                                <div class="col mr-2">
                                                    <div
                                                        class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                        Total Issues</div>
                                                    <div class="h5 mb-0 font-weight-bold text-gray-800"
                                                        id="totalIssues"><%= totalIssues %></div>
                                                </div>
                                                <div class="col-auto">
                                                    <i class="fas fa-ticket-alt fa-2x text-gray-300"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xl-3 col-md-6 mb-4">
                                    <div class="card border-left-success shadow h-100 py-2">
                                        <div class="card-body">
                                            <div class="row no-gutters align-items-center">
                                                <div class="col mr-2">
                                                    <div
                                                        class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                        Scheduled Today</div>
                                                    <div class="h5 mb-0 font-weight-bold text-gray-800"
                                                        id="activeIssues">0</div>
                                                </div>
                                                <div class="col-auto">
                                                    <i class="fas fa-clock fa-2x text-gray-300"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xl-3 col-md-6 mb-4">
                                    <div class="card border-left-warning shadow h-100 py-2">
                                        <div class="card-body">
                                            <div class="row no-gutters align-items-center">
                                                <div class="col mr-2">
                                                    <div
                                                        class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                        On Hold</div>
                                                    <div class="h5 mb-0 font-weight-bold text-gray-800"
                                                        id="onHoldIssues">0</div>
                                                </div>
                                                <div class="col-auto">
                                                    <i class="fas fa-pause fa-2x text-gray-300"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xl-3 col-md-6 mb-4">
                                    <div class="card border-left-info shadow h-100 py-2">
                                        <div class="card-body">
                                            <div class="row no-gutters align-items-center">
                                                <div class="col mr-2">
                                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                        Resolved Today</div>
                                                    <div class="h5 mb-0 font-weight-bold text-gray-800"
                                                        id="resolvedToday">0</div>
                                                </div>
                                                <div class="col-auto">
                                                    <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Issue List Table -->
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">All Issues</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="issueTable" width="100%"
                                            cellspacing="0">
                                            <thead>
                                                <tr>
                                                    <th>Issue ID</th>
                                                    <th>Contact</th>
                                                    <th>Device</th>
                                                    <th>Problem</th>
                                                    <th>Status</th>
                                                    <th>Priority</th>
                                                    <th>Assigned To</th>
                                                    <th>Created</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Sample data - will be populated dynamically -->
                                                <% issues.forEach(issue=> { %>
                                                    <tr data-issue='<%= JSON.stringify(issue) %>'>
                                                        <td><strong>
                                                                <%= issue.human_readable_id %>
                                                            </strong></td>
                                                        <td>
                                                            <div>

                                                                <strong>
                                                                    <%= issue.contact.name %>
                                                                </strong>
                                                            </div>
                                                            <small>
                                                                <%= issue.contact.phone %>
                                                            </small>
                                                        </td>
                                                        <td>
                                                            <div>
                                                                <%= issue.device.type %>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <%= issue.problemDescription %>
                                                        </td>
                                                        <td>
                                                            <% if( issue.status === 'new'){ %>
                                                            <span class="badge status-badge status-new">
                                                                <%= issue.status %>
                                                            </span>
                                                            <% } %>
                                                            <% if (issue.status === 'scheduled') {%>
                                                            <span class="badge status-badge status-scheduled">
                                                                <%= issue.status %>
                                                            </span>
                                                            <% } %>
                                                            <% if(issue.status === 'assigned') { %>
                                                               <span class="badge status-badge status-assigned">
                                                                <%= issue.status %>
                                                            </span> 
                                                            <% } %>
                                                            <% if(issue.status === 'in_progress') { %>
                                                                <span class="badge status-badge status-in-progress">
                                                                    <%= issue.status %>
                                                                </span>
                                                            <% } %>
                                                            <% if(issue.status === 'awaiting_payment'){ %>
                                                                <span class="badge status-badge status-awaiting_payment">
                                                                    Awaiting Payment
                                                                </span>
                                                            <% } %>
                                                            <% if(issue.status === 'resolved'){ %>
                                                                <span class="badge status-badge status-resolved">
                                                                    <%= issue.status %>
                                                                </span>
                                                            <% } %>
                                                        </td>
                                                        <td>
                                                            <%= issue.priority %>
                                                        </td>
                                                        <td>
                                                            <% if (issue.assignment && issue.assignment.technicianId) {
                                                                %>
                                                                <span class="text-success">
                                                                    <i class="fas fa-user-check"></i>
                                                                    <% if (typeof
                                                                        issue.assignment.technicianId==='object' &&
                                                                        issue.assignment.technicianId.firstName) { %>
                                                                        <%= issue.assignment.technicianId.firstName %>
                                                                            <%= issue.assignment.technicianId.lastName
                                                                                %>
                                                                                <% } else { %>
                                                                                    Assigned
                                                                                    <% } %>
                                                                </span>
                                                                <% } else { %>
                                                                    <span class="text-muted">
                                                                        <i class="fas fa-user-times"></i> Unassigned
                                                                    </span>
                                                                    <% } %>
                                                        </td>
                                                        <td>
                                                            <!-- This is mongodb date , make it like it would show created time difference from current time    -->
                                                            <%= moment(issue.createdAt).fromNow() %>
                                                        </td>
                                                        <td>
                                                            <div class="action-buttons">
                                                                <button class="btn btn-sm btn-primary view-issue-btn"
                                                                    title="View Details"
                                                                    data-issue-id="<%= issue.human_readable_id %>">
                                                                    <i class="fas fa-eye"></i>
                                                                </button>

                                                                <button class="btn btn-sm btn-warning history-issue-btn"
                                                                    title="History" id="history-issue-btn">
                                                                    <i class="fas fa-history"></i>
                                                                </button>


                                                                <button class="btn btn-sm btn-success schedule-issue-btn" title="Schedule" id="schedule-issue-btn" data-issue-id="<%= issue._id %>">
                                                                    <i class="fas fa-edit"></i>
                                                                </button>
                                                                <!-- Change this button below to assign to technician  -->
                                                                <button
                                                                    class="btn btn-sm btn-info assign-to-technician-btn"
                                                                    title="Assign to Technician"
                                                                    data-issue-id="<%= issue.human_readable_id %>">
                                                                    <i class="fas fa-user-plus"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                    </div>
                    <!-- /.container-fluid -->

                </div>
                <!-- End of Main Content -->

                <!-- Footer -->
                <footer class="sticky-footer bg-white">
                    <div class="container my-auto">
                        <div class="copyright text-center my-auto">
                            <span>Copyright &copy; Your Website 2024</span>
                        </div>
                    </div>
                </footer>
                <!-- End of Footer -->

            </div>
            <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Issue Details Modal -->
    <div class="modal fade" id="issueDetailsModal" tabindex="-1" role="dialog" aria-labelledby="issueDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="issueDetailsModalLabel">Issue Details</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Basic Information Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <div class="icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <h6>Basic Information</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <table class="info-table">
                                    <tr>
                                        <td>Issue ID:</td>
                                        <td id="modal-issue-id"></td>
                                    </tr>
                                    <tr>
                                        <td>Status:</td>
                                        <td id="modal-status"></td>
                                    </tr>
                                    <tr>
                                        <td>Priority:</td>
                                        <td id="modal-priority"></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="info-table">
                                    <tr>
                                        <td>Created:</td>
                                        <td id="modal-created"></td>
                                    </tr>
                                    <tr>
                                        <td>Assigned To:</td>
                                        <td id="modal-assigned"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <div class="icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <h6>Contact Information</h6>
                        </div>
                        <table class="info-table">
                            <tr>
                                <td>Name:</td>
                                <td id="modal-contact-name"></td>
                            </tr>
                            <tr>
                                <td>Phone:</td>
                                <td id="modal-contact-phone"></td>
                            </tr>
                            <tr>
                                <td>Email:</td>
                                <td id="modal-contact-email"></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Device Information Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <div class="icon">
                                <i class="fas fa-laptop"></i>
                            </div>
                            <h6>Device Information</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <table class="info-table">
                                    <tr>
                                        <td>Device Type:</td>
                                        <td id="modal-device-type"></td>
                                    </tr>
                                    <tr>
                                        <td>Brand:</td>
                                        <td id="modal-device-brand"></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="info-table">
                                    <tr>
                                        <td>Model:</td>
                                        <td id="modal-device-model"></td>
                                    </tr>
                                    <tr>
                                        <td>Serial Number:</td>
                                        <td id="modal-device-serial"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Problem Description Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <div class="icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h6>Problem Description</h6>
                        </div>
                        <div class="content-box">
                            <p id="modal-problem-description"></p>
                        </div>
                        <div id="modal-generic-problem-type" class="my-2">

                        </div>
                    </div>

                    <!-- Additional Notes Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <div class="icon">
                                <i class="fas fa-sticky-note"></i>
                            </div>
                            <h6>Additional Notes</h6>
                        </div>
                        <div class="content-box">
                            <p id="modal-notes">No additional notes available.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="modal-edit-btn">Edit Issue</button>
                    <button type="button" class="btn btn-info" id="modal-status-btn">Change Status</button>
                </div>
            </div>
        </div>
    </div>

    <!--- issue history modal --->    
    <div class="modal fade" id="issueHistoryModal" tabindex="-1" role="dialog" aria-labelledby="issueHistoryModalLabel"
      aria-hidden="true">
     <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="issueHistoryModalLabel">Issue History</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body" id="history-issue-modal-body">

                <!-- Status Changes Section -->
                <div class="section-card">
                    <div class="section-header">
                        <div class="icon">
                            <i class="fas fa-random"></i>
                        </div>
                        <h6>Status Changes</h6>
                    </div>
                    <div class="timeline-box" id="modal-history-status">
                        <!-- Example entry -->
                        <!--
                        <div class="history-entry">
                            <span class="time">2025-09-07 10:30</span>
                            <p><strong>Shahid Ali</strong> changed status from <em>scheduled</em> to <em>in_progress</em></p>
                            <small>Note: Engineer has started work</small>
                        </div>
                        -->
                    </div>
                </div>

                

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
   </div>


    <!-- Assign Technician Modal -->
    <div class="modal fade" id="assignTechnicianModal" tabindex="-1" role="dialog"
        aria-labelledby="assignTechnicianModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignTechnicianModalLabel">Assign Technician</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="assignTechnicianForm">
                        <input type="hidden" id="assign-issue-id" name="issueId">

                        <!-- Issue Information -->
                        <div class="section-card mb-3">
                            <div class="section-header">
                                <div class="icon">
                                    <i class="fas fa-ticket-alt"></i>
                                </div>
                                <h6>Issue Information</h6>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Issue ID:</strong>
                                    <span id="assign-modal-issue-id"></span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Priority:</strong>
                                    <span id="assign-modal-priority"></span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <strong>Problem:</strong>
                                    <span id="assign-modal-problem"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Technician Selection -->
                        <div class="form-group">
                            <label for="technicianSelect"><strong>Select Technician</strong></label>
                            <select class="form-control" id="technicianSelect" name="technicianId" required>
                                <option value="">Loading technicians...</option>
                            </select>
                            <small class="form-text text-muted">Choose a qualified technician for this service
                                type.</small>
                        </div>

                        <!-- Assignment Notes -->
                        <div class="form-group">
                            <label for="assignmentNotes"><strong>Assignment Notes</strong></label>
                            <textarea class="form-control" id="assignmentNotes" name="notes" rows="3"
                                placeholder="Enter any specific instructions or notes for the technician..."></textarea>
                        </div>

                        <!-- Priority Override -->
                        <div class="form-group">
                            <label for="priorityOverride"><strong>Priority (Optional Override)</strong></label>
                            <select class="form-control" id="priorityOverride" name="priority">
                                <option value="">Keep current priority</option>
                                <option value="low">Low</option>
                                <option value="normal">Normal</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmAssignBtn">
                        <i class="fas fa-user-plus"></i> Assign Technician
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Schedule Modal -->
    <div class="modal fade" id="issue_schedule_modal" tabindex="-1" role="dialog" aria-labelledby="issue_schedule_modal_label"
        aria-hidden="true">
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="issue_schedule_modal_label">Issue Schedule</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="issue_schedule_modal_body">
                    <div class="section-card mb-3">
                        <div class="section-header">
                            <div class="icon">
                                <i class="fas fa-ticket-alt"></i>
                            </div>
                            <h6>Issue Information</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Issue ID:</strong>
                                <span id="issue-schedule-modal-issue-id"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Priority:</strong>
                                <span id="issue-schedule-modal-priority"></span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <strong>Problem:</strong>
                                <span id="issue-schedule-modal-problem"></span>
                            </div>
                        </div>
                        <div class="row mt-2" id="issue-schedule-modal-schedule-information">
                            <div class="col-12">
                                <strong>Schedule Information:</strong>
                                <span id="issue-schedule-modal-notes"></span>
                            </div>
                        </div>
                    </div>
                    </div>
                    

                    <form id="issue-schedule-form">
                        <input type="hidden" id="to-be-scheduled-issue-id" name="issue_id" />
                        <div class="form-group">
                            <label for="timeWindow">Preferred Time Window</label>
                            <select class="form-control" id="timeWindow-issue-schedule-select" name="schedule.window">
                                <option value="any" selected>Any Time</option>
                                <option value="morning">Morning (9 AM - 12 PM)</option>
                                <option value="afternoon">Afternoon (12 PM - 3 PM)
                                </option>
                                <option value="evening">Evening (3 PM - 6 PM)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="preferredDate">Preferred Date (Optional)</label>
                            <input type="date" class="form-control" id="preferredDate-issue-schedule-input" name="schedule.preferredDate">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            Change Schedule
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Bootstrap core JavaScript-->
    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="/vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="/js/sb-admin-2.min.js"></script>

    <!-- DataTables JavaScript -->
    <script src="/vendor/datatables/jquery.dataTables.js"></script>
    <script src="/vendor/datatables/dataTables.bootstrap4.js"></script>
    <script src="/js/serach-functionality.js"></script>
    <!-- Custom JavaScript for this page -->
    <script>
        $(document).ready(function () {
            // Initialize DataTable
            $('#issueTable').DataTable({
                "order": [[7, "desc"]], // Sort by created date descending
                "pageLength": 25,
                "language": {
                    "search": "Search issues:",
                    "lengthMenu": "Show _MENU_ issues per page",
                    "info": "Showing _START_ to _END_ of _TOTAL_ issues",
                    "paginate": {
                        "first": "First",
                        "last": "Last",
                        "next": "Next",
                        "previous": "Previous"
                    }
                }
            });

            // Update statistics (this would typically come from API)
            updateStatistics();

            // Add event listeners for action buttons
            $('.action-buttons .btn').on('click', function () {
                const action = $(this).attr('title');
                const issueId = $(this).closest('tr').find('td:first strong').text();

                if (action === 'View Details') {
                    viewIssueDetails(issueId);
                } else if (action === 'Edit') {
                    // editIssue(issueId);
                } else if (action === 'Change Status') {
                    changeIssueStatus(issueId);
                }
            });

            // Add specific event listener for view button
            $(document).on('click', '.view-issue-btn', function (e) {
                e.preventDefault();
                const issueId = $(this).data('issue-id');
                const issueRow = $(this).closest('tr');
                const issueData = JSON.parse(issueRow.attr('data-issue'));
                openIssueModal(issueData);
            });

            // Modal button event listeners
            $('#modal-edit-btn').on('click', function () {
                const issueId = $('#modal-issue-id').text();
                editIssue(issueId);
            });

            $('#modal-status-btn').on('click', function () {
                const issueId = $('#modal-issue-id').text();
                changeIssueStatus(issueId);
            });

            // Ensure modal closes properly
            $('#issueDetailsModal').on('hidden.bs.modal', function () {
                // Reset modal content when closed
                $(this).find('input, textarea').val('');
            });

            // Add click outside modal to close functionality
            $(document).on('click', function (e) {
                if ($(e.target).hasClass('modal') && !$(e.target).hasClass('modal-content')) {
                    $('#issueDetailsModal').modal('hide');
                }
            });

            // Force close modal with escape key
            $(document).on('keydown', function (e) {
                if (e.key === 'Escape' && $('#issueDetailsModal').hasClass('show')) {
                    closeIssueModal();
                }
            });

            // Add click handlers for close buttons
            $('.close, [data-dismiss="modal"], [data-bs-dismiss="modal"]').on('click', function () {
                const modalId = $(this).closest('.modal').attr('id');
                closeIssueModal(modalId);
            });


            $(document).on('click', '.assign-to-technician-btn', function () {
                const issueId = $(this).data('issue-id');
                const issueRow = $(this).closest('tr');
                const issueData = JSON.parse(issueRow.attr('data-issue'));

                openAssignTechnicianModal(issueData);
            });

            $(document).on('click', '.schedule-issue-btn', function () {
                const issueId = $(this).data('issue-id');
                const issueRow = $(this).closest('tr');
                const issueData = JSON.parse(issueRow.attr('data-issue'));
                openIssueScheduleModal(issueData);
            });

            $(document).on('click','.history-issue-btn',function (){
                const issueId = $(this).data('issue-id');
                const issueRow = $(this).closest('tr');
                const issueData = JSON.parse(issueRow.attr('data-issue'));
                openIssueHistoryModal(issueData)
            })

        });

        function openIssueHistoryModal(issueData) {
        $.ajax({
        url: `/get-issue-history/${issueData._id}`,
        type: 'GET',
        success: function (response) {
            if (response && response.data && response.data.length > 0) {
                const container = $('#modal-history-status');
                container.empty(); // clear old entries

                response.data.forEach(entry => {
                    const userName = entry.by?.name || "Unknown User";
                    const action = entry.action || "updated";
                    const fromStatus = entry.from || "-";
                    const toStatus = entry.to || "-";
                    const note = entry.note || ""; // if you add note field
                    const time = new Date(entry.at).toLocaleString();

                    const html = `
                        <div class="history-entry">
                            <span class="time">${time}</span>
                            <p>
                                <strong>${userName}</strong> 
                                ${action} from 
                                <em>${fromStatus}</em> 
                                to 
                                <em>${toStatus}</em>
                            </p>
                            ${note ? `<small>Note: ${note}</small>` : ""}
                        </div>
                    `;
                    container.append(html);
                });
            } else {
                $('#modal-history-status').html('<p>No history available.</p>');
            }

            // finally open the modal
            $('#issueHistoryModal').modal('show');
        },
        error: function (xhr) {
            console.error("Error fetching issue history:", xhr);
            $('#modal-history-status').html('<p class="text-danger">Failed to load history.</p>');
            $('#issueHistoryModal').modal('show');
        }
    });
}


        function updateStatistics() {
            // This would typically fetch data from an API
            // For now, using sample data
            
            $('#activeIssues').text('2');
            $('#onHoldIssues').text('0');
            $('#resolvedToday').text('1');
        }

        function openIssueModal(issueData) {
            // Populate modal with issue data
            $('#modal-issue-id').text(issueData.human_readable_id || 'N/A');
            $('#modal-status').html(`<span class="badge status-badge status-${issueData.status.toLowerCase().replace(/[^a-z0-9]/g, '_')}">${issueData.status}</span>`);
            $('#modal-priority').text(issueData.priority || 'N/A');
            $('#modal-created').text(new Date(issueData.createdAt).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }));
            $('#modal-assigned').text('Unassigned'); // You can update this based on your data structure

            // Contact information
            $('#modal-contact-name').text(issueData.contact?.name || 'N/A');
            $('#modal-contact-phone').text(issueData.contact?.phone || 'N/A');
            $('#modal-contact-email').text(issueData.contact?.email || 'N/A');

            // Device information
            $('#modal-device-type').text(issueData.device?.type || 'N/A');
            $('#modal-device-brand').text(issueData.device?.brand || 'N/A');
            $('#modal-device-model').text(issueData.device?.model || 'N/A');
            $('#modal-device-serial').text(issueData.device?.serialNumber || 'N/A');

            // Problem description
            $('#modal-problem-description').text(issueData.problemDescription || 'No description available');
            let generictypehtml = ''
            console.log(issueData);
            issueData.generic_problem_type.forEach(type => {

                if(type === 'display_issue'){
                    generictypehtml += `
                    <div class="problem-type-option btn btn-outline-primary">
                        <i class="problem-icon fas fa-desktop"></i>
                    <span >Display Issue</span>
                    </div>
                    `;
                }else if(type === 'sound_issue'){
                    generictypehtml += `
                    <div class="problem-type-option btn btn-outline-primary">
                        <i class="problem-icon fas fa-volume-mute"></i>
                    <span >Sound Issue</span>
                    </div>
                    `;
                }else if(type === 'power_issue'){
                    generictypehtml += `
                    <div class="problem-type-option btn btn-outline-primary">
                        <i class="problem-icon fas fa-power-off"></i>
                    <span >Power Issue</span>
                    </div>
                    `;
                }else if(type === 'unknown_issue'){
                    generictypehtml += `
                    <div class="problem-type-option btn btn-outline-primary">
                        <i class="problem-icon fas fa-question-circle"></i>
                    <span >Unknown Issue</span>
                    </div>
                    `;
                }
            });
            $('#modal-generic-problem-type').html(generictypehtml);
            // Additional notes (if available)
            if (issueData.notes) {
                $('#modal-notes').text(issueData.notes);
            } else {
                $('#modal-notes').text('No additional notes available.');
            }

            // Show the modal
            $('#issueDetailsModal').modal('show');
        }

        function closeIssueModal(modalId) {
            // Blur active element (avoid aria-hidden focus issue)
            if (document.activeElement) {
                document.activeElement.blur();
            }

            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                // Bootstrap 5
                const modalEl = document.getElementById(modalId);
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
            } else {
                // Bootstrap 4
                $('#' + modalId).modal('hide');
            }
        }

        function viewIssueDetails(issueId) {
            // This function is now handled by the modal
            // Find the issue data and open modal
            const issueRow = $(`tr[data-issue*="${issueId}"]`);
            if (issueRow.length > 0) {
                const issueData = JSON.parse(issueRow.attr('data-issue'));
                openIssueModal(issueData);
            }
        }

        function editIssue(issueId) {
            // Navigate to edit issue page
            window.location.href = `/edit-issue/${issueId}`;
        }

        function changeIssueStatus(issueId) {
            // Show status change modal
            alert(`Change status for issue ${issueId}`);
            // In a real implementation, this would open a modal with status options
        }
        
        function openIssueScheduleModal(issueData) {
            $('#issue-schedule-modal-issue-id').text(issueData.human_readable_id);
            $('#issue-schedule-modal-priority').text(issueData.priority);
            $('#issue-schedule-modal-problem').text(issueData.problemDescription);
            $('#to-be-scheduled-issue-id').val(issueData._id)
            loadIssueSchedule(issueData._id);
            $('#issue_schedule_modal').modal('show');
        }

        function loadIssueSchedule(issueID){
            $.ajax({
                url: `/get-current-schedule/${issueID}`,
                method: 'GET',
                success: function (response) {
                    console.log('Issue schedule response:', response);

                    if (response && response.data && response.data.preferredDate && response.data.window) {
                        const preferredDate = response.data.preferredDate;
                        const timeWindow = response.data.window;
                        const formattedDate = preferredDate.split('T')[0]
                        $('#preferredDate-issue-schedule-input').val(formattedDate);
                        $('#timeWindow-issue-schedule-select').val(timeWindow)

                        $('#issue-schedule-modal-schedule-information').html(`<div class="col-12">
                                <strong>Schedule Information:<span class="text-success">Scheduled (<span id="issue-schedule-modal-notes">${formattedDate} - ${timeWindow}</span>)</span></strong>
                                
                            </div>`);

                    }else{
                        $('#issue-schedule-modal-schedule-information').html(`<div class="col-12">
                                <strong>Schedule Information:<span class="text-danger text-sm"> Not Scheduled</span></strong>
                                <span id="issue-schedule-modal-notes"></span>
                            </div>`);
                    }
                },
                error: function (xhr) {
                    console.log('Issue schedule error:', xhr);
                }
            });
        }

        function openAssignTechnicianModal(issueData) {
            // Populate modal with issue data
            $('#assign-issue-id').val(issueData.human_readable_id);
            $('#assign-modal-issue-id').text(issueData.human_readable_id);
            $('#assign-modal-priority').html(`<span class="badge status-badge status-${issueData.priority}">${issueData.priority}</span>`);
            $('#assign-modal-problem').text(issueData.problemDescription || 'No description available');

            // Reset form
            $('#assignTechnicianForm')[0].reset();
            $('#assign-issue-id').val(issueData.human_readable_id);
            console.log('issueData', issueData);
            // Load technicians for this service category
            loadTechniciansForIssue(issueData.serviceCategoryId);

            // Show the modal
            $('#assignTechnicianModal').modal('show');
        }

        function loadTechniciansForIssue(serviceCategoryId) {
            $('#technicianSelect').html('<option value="">Loading technicians...</option>');

            console.log('Loading technicians for service category:', serviceCategoryId._id);

            // Check if serviceCategoryId is valid
            if (!serviceCategoryId._id) {
                $('#technicianSelect').html('<option value="">No service category specified</option>');
                return;
            }

            $.ajax({
                url: `/get-technicians-to-assign/${serviceCategoryId._id}`,
                method: 'GET',
                success: function (response) {
                    console.log('Technicians response:', response);

                    if (response.success && response.data && response.data.length > 0) {
                        let options = '<option value="">Select a technician...</option>';

                        response.data.forEach(function (item) {
                            if (item.technician) {
                                const tech = item.technician;
                                options += `<option value="${tech._id}">${tech.firstName} ${tech.lastName} - ${tech.phone}</option>`;
                            }
                        });

                        $('#technicianSelect').html(options);
                        console.log('Loaded', response.data.length, 'technicians');
                    } else {
                        console.log('No technicians found or invalid response');
                        $('#technicianSelect').html('<option value="">No technicians available for this service</option>');
                    }
                },
                error: function () {
                    $('#technicianSelect').html('<option value="">Error loading technicians</option>');
                    showNotification('Error loading technicians', 'error');
                }
            });
        }
         
        $('#issue-schedule-form').on('submit',function(e){
            e.preventDefault()
            $.ajax({
                url:'/change-schedule',
                type:'POST',
                data:$(this).serialize(),
                success:function(response){
                   if(response.success){
                    showNotification('Issue scheduled successfully')
                    $('#issue_schedule_modal').modal('hide')
                    setTimeout(function () {
                            location.reload();
                        }, 1500);
                   }
                },
                error:function(xhr,status,err){
                 const response = xhr.responseJSON;
                    showNotification(response?.message || 'Schedule failed', 'error');
                }
            })
        })
        // Handle assignment confirmation
        $(document).on('click', '#confirmAssignBtn', function () {
            const form = $('#assignTechnicianForm');
            const issueId = $('#assign-issue-id').val();
            const technicianId = $('#technicianSelect').val();
            const notes = $('#assignmentNotes').val();
            const priority = $('#priorityOverride').val();

            if (!technicianId) {
                showNotification('Please select a technician', 'error');
                return;
            }

            // Disable button and show loading
            $('#confirmAssignBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Assigning...');

            $.ajax({
                url: `/assign-issue-to-technician/${issueId}`,
                method: 'POST',
                data: {
                    technicianId: technicianId,
                    notes: notes,
                    priority: priority || undefined
                },
                success: function (response) {
                    if (response.success) {
                        showNotification('Technician assigned successfully!', 'success');
                        $('#assignTechnicianModal').modal('hide');

                        // Update the UI to show assignment
                        updateAssignmentInTable(issueId, response.data);

                        // Optionally reload the page to reflect changes
                        setTimeout(function () {
                            location.reload();
                        }, 1500);
                    } else {
                        showNotification(response.message || 'Assignment failed', 'error');
                    }
                },
                error: function (xhr) {
                    const response = xhr.responseJSON;
                    showNotification(response?.message || 'Assignment failed', 'error');
                },
                complete: function () {
                    $('#confirmAssignBtn').prop('disabled', false).html('<i class="fas fa-user-plus"></i> Assign Technician');
                }
            });
        });

        function updateAssignmentInTable(issueId, assignmentData) {
            // Find the row and update the "Assigned To" column
            $('table tbody tr').each(function () {
                const row = $(this);
                const rowIssueId = row.find('td:first strong').text().trim();

                if (rowIssueId === issueId) {
                    const assignedToCell = row.find('td').eq(6); // Assuming "Assigned To" is the 7th column (index 6)
                    if (assignmentData && assignmentData.technicianName) {
                        assignedToCell.html(`<span class="text-success">${assignmentData.technicianName}</span>`);
                    }
                }
            });
        }

        function showNotification(message, type = 'info') {
            // Create a simple notification
            const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
            const notification = $(`
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    ${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
            `);

            $('body').append(notification);

            // Auto-remove after 5 seconds
            setTimeout(function () {
                notification.alert('close');
            }, 5000);
        }

        // Refresh data every 30 seconds
        setInterval(function () {
            // This would typically refresh the table data from an API
            console.log('Refreshing issue data...');
        }, 30000);
    </script>
    <script>
    // Get today's date
    const today = new Date();
    // Add 1 day to ensure only future dates are selectable
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);

    // Format as yyyy-mm-dd
    const minDate = tomorrow.toISOString().split("T")[0];
    document.getElementById("preferredDate-issue-schedule-input").setAttribute("min", minDate);
</script>

</body>

</html>